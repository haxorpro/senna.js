(function(global,factory){typeof exports==='object'&&typeof module!=='undefined'?factory(exports):typeof define==='function'&&define.amd?define(['exports'],factory):(factory((global.senna={})));}(this,(function(exports){'use strict';var _typeof=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(obj){return typeof obj;}:function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj;};var classCallCheck=function(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}};var createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}
return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};}();var get=function get(object,property,receiver){if(object===null)object=Function.prototype;var desc=Object.getOwnPropertyDescriptor(object,property);if(desc===undefined){var parent=Object.getPrototypeOf(object);if(parent===null){return undefined;}else{return get(parent,property,receiver);}}else if("value"in desc){return desc.value;}else{var getter=desc.get;if(getter===undefined){return undefined;}
return getter.call(receiver);}};var inherits=function(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);}
subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass;};var possibleConstructorReturn=function(self,call){if(!self){throw new ReferenceError("this hasn't been initialised - super() hasn't been called");}
return call&&(typeof call==="object"||typeof call==="function")?call:self;};var slicedToArray=function(){function sliceIterator(arr,i){var _arr=[];var _n=true;var _d=false;var _e=undefined;try{for(var _i=arr[Symbol.iterator](),_s;!(_n=(_s=_i.next()).done);_n=true){_arr.push(_s.value);if(i&&_arr.length===i)break;}}catch(err){_d=true;_e=err;}finally{try{if(!_n&&_i["return"])_i["return"]();}finally{if(_d)throw _e;}}
return _arr;}
return function(arr,i){if(Array.isArray(arr)){return arr;}else if(Symbol.iterator in Object(arr)){return sliceIterator(arr,i);}else{throw new TypeError("Invalid attempt to destructure non-iterable instance");}};}();function isDef(val){return val!==undefined;}
function isDefAndNotNull(val){return isDef(val)&&!isNull(val);}
function isDocument(val){return val&&(typeof val==='undefined'?'undefined':_typeof(val))==='object'&&val.nodeType===9;}
function isFunction(val){return typeof val==='function';}
function isNull(val){return val===null;}
function isObject(val){var type=typeof val==='undefined'?'undefined':_typeof(val);return type==='object'&&val!==null||type==='function';}
function isString(val){return typeof val==='string'||val instanceof String;}
function isServerSide(){var options=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{checkEnv:true};var serverSide=typeof process!=='undefined'&&!process.browser;if(serverSide&&options.checkEnv){serverSide=typeof process.env!=='undefined'&&process.env.NODE_ENV!=='test';}
return serverSide;}
var array=function(){function array(){classCallCheck(this,array);}
createClass(array,null,[{key:'equal',value:function equal(arr1,arr2){if(arr1===arr2){return true;}
if(arr1.length!==arr2.length){return false;}
for(var i=0;i<arr1.length;i++){if(arr1[i]!==arr2[i]){return false;}}
return true;}},{key:'firstDefinedValue',value:function firstDefinedValue(arr){for(var i=0;i<arr.length;i++){if(arr[i]!==undefined){return arr[i];}}}},{key:'flatten',value:function flatten(arr){var output=arguments.length>1&&arguments[1]!==undefined?arguments[1]:[];for(var i=0;i<arr.length;i++){if(Array.isArray(arr[i])){array.flatten(arr[i],output);}else{output.push(arr[i]);}}
return output;}},{key:'remove',value:function remove(arr,obj){var i=arr.indexOf(obj);var rv=void 0;if(rv=i>=0){array.removeAt(arr,i);}
return rv;}},{key:'removeAt',value:function removeAt(arr,i){return Array.prototype.splice.call(arr,i,1).length===1;}},{key:'slice',value:function slice(arr,start){var end=arguments.length>2&&arguments[2]!==undefined?arguments[2]:arr.length;var sliced=[];for(var i=start;i<end;i++){sliced.push(arr[i]);}
return sliced;}}]);return array;}();var async={};async.throwException=function(exception){async.nextTick(function(){throw exception;});};async.run=function(callback,context){if(!async.run.workQueueScheduled_){async.nextTick(async.run.processWorkQueue);async.run.workQueueScheduled_=true;}
async.run.workQueue_.push(new async.run.WorkItem_(callback,context));};async.run.workQueueScheduled_=false;async.run.workQueue_=[];async.run.processWorkQueue=function(){while(async.run.workQueue_.length){var workItems=async.run.workQueue_;async.run.workQueue_=[];for(var i=0;i<workItems.length;i++){var workItem=workItems[i];try{workItem.fn.call(workItem.scope);}catch(e){async.throwException(e);}}}
async.run.workQueueScheduled_=false;};async.run.WorkItem_=function(fn,scope){this.fn=fn;this.scope=scope;};async.nextTick=function(callback,context){var cb=callback;if(context){cb=callback.bind(context);}
cb=async.nextTick.wrapCallback_(cb);if(!async.nextTick.setImmediate_){if(typeof setImmediate==='function'&&isServerSide({checkEnv:false})){async.nextTick.setImmediate_=setImmediate;}else{async.nextTick.setImmediate_=async.nextTick.getSetImmediateEmulator_();}}
async.nextTick.setImmediate_(cb);};async.nextTick.setImmediate_=null;async.nextTick.getSetImmediateEmulator_=function(){var Channel=void 0;if(typeof MessageChannel==='function'){Channel=MessageChannel;}
if(typeof Channel==='undefined'&&typeof window!=='undefined'&&window.postMessage&&window.addEventListener){Channel=function Channel(){var iframe=document.createElement('iframe');iframe.style.display='none';iframe.src='';iframe.title='';document.documentElement.appendChild(iframe);var win=iframe.contentWindow;var doc=win.document;doc.open();doc.write('');doc.close();var message='callImmediate'+Math.random();var origin=win.location.protocol+'//'+win.location.host;var onmessage=function(e){if(e.origin!==origin&&e.data!==message){return;}
this.port1.onmessage();}.bind(this);win.addEventListener('message',onmessage,false);this.port1={};this.port2={postMessage:function postMessage(){win.postMessage(message,origin);}};};}
if(typeof Channel!=='undefined'){var channel=new Channel();var head={};var tail=head;channel.port1.onmessage=function(){head=head.next;var cb=head.cb;head.cb=null;cb();};return function(cb){tail.next={cb:cb};tail=tail.next;channel.port2.postMessage(0);};}
if(typeof document!=='undefined'&&'onreadystatechange'in document.createElement('script')){return function(cb){var script=document.createElement('script');script.onreadystatechange=function(){script.onreadystatechange=null;script.parentNode.removeChild(script);script=null;cb();cb=null;};document.documentElement.appendChild(script);};}
return function(cb){setTimeout(cb,0);};};async.nextTick.wrapCallback_=function(callback){return callback;};var Disposable=function(){function Disposable(){classCallCheck(this,Disposable);this.disposed_=false;}
createClass(Disposable,[{key:'dispose',value:function dispose(){if(!this.disposed_){this.disposeInternal();this.disposed_=true;}}},{key:'disposeInternal',value:function disposeInternal(){}},{key:'isDisposed',value:function isDisposed(){return this.disposed_;}}]);return Disposable;}();var object=function(){function object(){classCallCheck(this,object);}
createClass(object,null,[{key:'mixin',value:function mixin(target){var key=void 0;var source=void 0;for(var _len=arguments.length,args=Array(_len>1?_len-1:0),_key=1;_key<_len;_key++){args[_key-1]=arguments[_key];}
for(var i=0;i<args.length;i++){source=args[i];for(key in source){target[key]=source[key];}}
return target;}},{key:'getObjectByName',value:function getObjectByName(name){var scope=arguments.length>1&&arguments[1]!==undefined?arguments[1]:window;var parts=name.split('.');return parts.reduce(function(part,key){return part[key];},scope);}},{key:'map',value:function map(obj,fn){var mappedObj={};var keys=Object.keys(obj);for(var i=0;i<keys.length;i++){mappedObj[keys[i]]=fn(keys[i],obj[keys[i]]);}
return mappedObj;}},{key:'shallowEqual',value:function shallowEqual(obj1,obj2){if(obj1===obj2){return true;}
var keys1=Object.keys(obj1);var keys2=Object.keys(obj2);if(keys1.length!==keys2.length){return false;}
for(var i=0;i<keys1.length;i++){if(obj1[keys1[i]]!==obj2[keys1[i]]){return false;}}
return true;}}]);return object;}();var string=function(){function string(){classCallCheck(this,string);}
createClass(string,null,[{key:'caseInsensitiveCompare',value:function caseInsensitiveCompare(str1,str2){var test1=String(str1).toLowerCase();var test2=String(str2).toLowerCase();if(test1<test2){return-1;}else if(test1===test2){return 0;}else{return 1;}}},{key:'collapseBreakingSpaces',value:function collapseBreakingSpaces(str){return str.replace(/[\t\r\n ]+/g,' ').replace(/^[\t\r\n ]+|[\t\r\n ]+$/g,'');}},{key:'escapeRegex',value:function escapeRegex(str){return String(str).replace(/([-()[\]{}+?*.$^|,:#<!\\])/g,'\\$1').replace(/\x08/g,'\\x08');}},{key:'getRandomString',value:function getRandomString(){var x=2147483648;return Math.floor(Math.random()*x).toString(36)+Math.abs(Math.floor(Math.random()*x)^Date.now()).toString(36);}},{key:'hashCode',value:function hashCode(val){var hash=0;for(var i=0,len=val.length;i<len;i++){hash=31*hash+val.charCodeAt(i);hash%=0x100000000;}
return hash;}},{key:'replaceInterval',value:function replaceInterval(str,start,end,value){return str.substring(0,start)+value+str.substring(end);}}]);return string;}();var METAL_DATA='__metal_data__';var domData=function(){function domData(){classCallCheck(this,domData);}
createClass(domData,null,[{key:'get',value:function get$$1(element,name,initialValue){if(!element[METAL_DATA]){element[METAL_DATA]={};}
if(!name){return element[METAL_DATA];}
if(!isDef(element[METAL_DATA][name])&&isDef(initialValue)){element[METAL_DATA][name]=initialValue;}
return element[METAL_DATA][name];}},{key:'has',value:function has(element){return!!element[METAL_DATA];}},{key:'set',value:function set$$1(element,name,value){if(!element[METAL_DATA]){element[METAL_DATA]={};}
if(!name||!isDef(value)){return element[METAL_DATA];}
element[METAL_DATA][name]=value;return element[METAL_DATA][name];}}]);return domData;}();var EventHandle=function(_Disposable){inherits(EventHandle,_Disposable);function EventHandle(emitter,event,listener){classCallCheck(this,EventHandle);var _this=possibleConstructorReturn(this,(EventHandle.__proto__||Object.getPrototypeOf(EventHandle)).call(this));_this.emitter_=emitter;_this.event_=event;_this.listener_=listener;return _this;}
createClass(EventHandle,[{key:'disposeInternal',value:function disposeInternal(){this.removeListener();this.emitter_=null;this.listener_=null;}},{key:'removeListener',value:function removeListener(){if(!this.emitter_.isDisposed()){this.emitter_.removeListener(this.event_,this.listener_);}}}]);return EventHandle;}(Disposable);var singleArray_=[0];var EventEmitter$1=function(_Disposable){inherits(EventEmitter,_Disposable);function EventEmitter(){classCallCheck(this,EventEmitter);var _this=possibleConstructorReturn(this,(EventEmitter.__proto__||Object.getPrototypeOf(EventEmitter)).call(this));_this.events_=null;_this.listenerHandlers_=null;_this.shouldUseFacade_=false;return _this;}
createClass(EventEmitter,[{key:'addHandler_',value:function addHandler_(holder,handler){if(!holder){holder=handler;}else{if(!Array.isArray(holder)){holder=[holder];}
holder.push(handler);}
return holder;}},{key:'addListener',value:function addListener(event,listener,defaultListener){this.validateListener_(listener);var events=this.toEventsArray_(event);for(var i=0;i<events.length;i++){this.addSingleListener_(events[i],listener,defaultListener);}
return new EventHandle(this,event,listener);}},{key:'addSingleListener_',value:function addSingleListener_(event,listener,defaultListener,origin){this.runListenerHandlers_(event);if(defaultListener||origin){listener={default:defaultListener,fn:listener,origin:origin};}
this.events_=this.events_||{};this.events_[event]=this.addHandler_(this.events_[event],listener);}},{key:'buildFacade_',value:function buildFacade_(event){if(this.getShouldUseFacade()){var facade={preventDefault:function preventDefault(){facade.preventedDefault=true;},target:this,type:event};return facade;}}},{key:'disposeInternal',value:function disposeInternal(){this.events_=null;}},{key:'emit',value:function emit(event){var listeners=this.getRawListeners_(event);if(listeners.length===0){return false;}
var args=array.slice(arguments,1);this.runListeners_(listeners,args,this.buildFacade_(event));return true;}},{key:'getRawListeners_',value:function getRawListeners_(event){var directListeners=toArray$1(this.events_&&this.events_[event]);return directListeners.concat(toArray$1(this.events_&&this.events_['*']));}},{key:'getShouldUseFacade',value:function getShouldUseFacade(){return this.shouldUseFacade_;}},{key:'listeners',value:function listeners(event){return this.getRawListeners_(event).map(function(listener){return listener.fn?listener.fn:listener;});}},{key:'many',value:function many(event,amount,listener){var events=this.toEventsArray_(event);for(var i=0;i<events.length;i++){this.many_(events[i],amount,listener);}
return new EventHandle(this,event,listener);}},{key:'many_',value:function many_(event,amount,listener){var self=this;if(amount<=0){return;}
function handlerInternal(){if(--amount===0){self.removeListener(event,handlerInternal);}
listener.apply(self,arguments);}
self.addSingleListener_(event,handlerInternal,false,listener);}},{key:'matchesListener_',value:function matchesListener_(listenerObj,listener){var fn=listenerObj.fn||listenerObj;return fn===listener||listenerObj.origin&&listenerObj.origin===listener;}},{key:'off',value:function off(event,listener){this.validateListener_(listener);if(!this.events_){return this;}
var events=this.toEventsArray_(event);for(var i=0;i<events.length;i++){this.events_[events[i]]=this.removeMatchingListenerObjs_(toArray$1(this.events_[events[i]]),listener);}
return this;}},{key:'on',value:function on(){return this.addListener.apply(this,arguments);}},{key:'onListener',value:function onListener(handler){this.listenerHandlers_=this.addHandler_(this.listenerHandlers_,handler);}},{key:'once',value:function once(events,listener){return this.many(events,1,listener);}},{key:'removeAllListeners',value:function removeAllListeners(event){if(this.events_){if(event){var events=this.toEventsArray_(event);for(var i=0;i<events.length;i++){this.events_[events[i]]=null;}}else{this.events_=null;}}
return this;}},{key:'removeMatchingListenerObjs_',value:function removeMatchingListenerObjs_(listenerObjs,listener){var finalListeners=[];for(var i=0;i<listenerObjs.length;i++){if(!this.matchesListener_(listenerObjs[i],listener)){finalListeners.push(listenerObjs[i]);}}
return finalListeners.length>0?finalListeners:null;}},{key:'removeListener',value:function removeListener(){return this.off.apply(this,arguments);}},{key:'runListenerHandlers_',value:function runListenerHandlers_(event){var handlers=this.listenerHandlers_;if(handlers){handlers=toArray$1(handlers);for(var i=0;i<handlers.length;i++){handlers[i](event);}}}},{key:'runListeners_',value:function runListeners_(listeners,args,facade){if(facade){args.push(facade);}
var defaultListeners=[];for(var i=0;i<listeners.length;i++){var listener=listeners[i].fn||listeners[i];if(listeners[i].default){defaultListeners.push(listener);}else{listener.apply(this,args);}}
if(!facade||!facade.preventedDefault){for(var j=0;j<defaultListeners.length;j++){defaultListeners[j].apply(this,args);}}}},{key:'setShouldUseFacade',value:function setShouldUseFacade(shouldUseFacade){this.shouldUseFacade_=shouldUseFacade;return this;}},{key:'toEventsArray_',value:function toEventsArray_(events){if(isString(events)){singleArray_[0]=events;events=singleArray_;}
return events;}},{key:'validateListener_',value:function validateListener_(listener){if(!isFunction(listener)){throw new TypeError('Listener must be a function');}}}]);return EventEmitter;}(Disposable);function toArray$1(val){val=val||[];return Array.isArray(val)?val:[val];}
var EventEmitterProxy=function(_Disposable){inherits(EventEmitterProxy,_Disposable);function EventEmitterProxy(originEmitter,targetEmitter,blacklist,whitelist){classCallCheck(this,EventEmitterProxy);var _this=possibleConstructorReturn(this,(EventEmitterProxy.__proto__||Object.getPrototypeOf(EventEmitterProxy)).call(this));_this.blacklist_=blacklist;_this.originEmitter_=originEmitter;_this.pendingEvents_=null;_this.proxiedEvents_=null;_this.targetEmitter_=targetEmitter;_this.whitelist_=whitelist;_this.startProxy_();return _this;}
createClass(EventEmitterProxy,[{key:'addListener_',value:function addListener_(event,listener){return this.originEmitter_.on(event,listener);}},{key:'disposeInternal',value:function disposeInternal(){this.removeListeners_();this.proxiedEvents_=null;this.originEmitter_=null;this.targetEmitter_=null;}},{key:'emitOnTarget_',value:function emitOnTarget_(){var _targetEmitter_;(_targetEmitter_=this.targetEmitter_).emit.apply(_targetEmitter_,arguments);}},{key:'proxyEvent',value:function proxyEvent(event){if(this.shouldProxyEvent_(event)){this.tryToAddListener_(event);}}},{key:'removeListeners_',value:function removeListeners_(){if(this.proxiedEvents_){var events=Object.keys(this.proxiedEvents_);for(var i=0;i<events.length;i++){this.proxiedEvents_[events[i]].removeListener();}
this.proxiedEvents_=null;}
this.pendingEvents_=null;}},{key:'setOriginEmitter',value:function setOriginEmitter(originEmitter){var _this2=this;var events=this.originEmitter_&&this.proxiedEvents_?Object.keys(this.proxiedEvents_):this.pendingEvents_;this.originEmitter_=originEmitter;if(events){this.removeListeners_();events.forEach(function(event){return _this2.proxyEvent(event);});}}},{key:'shouldProxyEvent_',value:function shouldProxyEvent_(event){if(this.whitelist_&&!this.whitelist_[event]){return false;}
if(this.blacklist_&&this.blacklist_[event]){return false;}
return!this.proxiedEvents_||!this.proxiedEvents_[event];}},{key:'startProxy_',value:function startProxy_(){this.targetEmitter_.onListener(this.proxyEvent.bind(this));}},{key:'tryToAddListener_',value:function tryToAddListener_(event){if(this.originEmitter_){this.proxiedEvents_=this.proxiedEvents_||{};this.proxiedEvents_[event]=this.addListener_(event,this.emitOnTarget_.bind(this,event));}else{this.pendingEvents_=this.pendingEvents_||[];this.pendingEvents_.push(event);}}}]);return EventEmitterProxy;}(Disposable);var EventHandler=function(_Disposable){inherits(EventHandler,_Disposable);function EventHandler(){classCallCheck(this,EventHandler);var _this=possibleConstructorReturn(this,(EventHandler.__proto__||Object.getPrototypeOf(EventHandler)).call(this));_this.eventHandles_=[];return _this;}
createClass(EventHandler,[{key:'add',value:function add(){for(var _len=arguments.length,args=Array(_len),_key=0;_key<_len;_key++){args[_key]=arguments[_key];}
for(var i=0;i<arguments.length;i++){this.eventHandles_.push(args[i]);}}},{key:'disposeInternal',value:function disposeInternal(){this.eventHandles_=null;}},{key:'removeAllListeners',value:function removeAllListeners(){for(var i=0;i<this.eventHandles_.length;i++){this.eventHandles_[i].removeListener();}
this.eventHandles_=[];}}]);return EventHandler;}(Disposable);var DomDelegatedEventHandle=function(_EventHandle){inherits(DomDelegatedEventHandle,_EventHandle);function DomDelegatedEventHandle(emitter,event,listener,selector){classCallCheck(this,DomDelegatedEventHandle);var _this=possibleConstructorReturn(this,(DomDelegatedEventHandle.__proto__||Object.getPrototypeOf(DomDelegatedEventHandle)).call(this,emitter,event,listener));_this.selector_=selector;return _this;}
createClass(DomDelegatedEventHandle,[{key:'removeListener',value:function removeListener(){var delegating=domData.get(this.emitter_,'delegating',{});var listeners=domData.get(this.emitter_,'listeners',{});var selector=this.selector_;var arr=isString(selector)?delegating[this.event_].selectors:listeners;var key=isString(selector)?selector:this.event_;array.remove(arr[key]||[],this.listener_);if(arr[key]&&arr[key].length===0){delete arr[key];}}}]);return DomDelegatedEventHandle;}(EventHandle);var DomEventHandle=function(_EventHandle){inherits(DomEventHandle,_EventHandle);function DomEventHandle(emitter,event,listener,capture){classCallCheck(this,DomEventHandle);var _this=possibleConstructorReturn(this,(DomEventHandle.__proto__||Object.getPrototypeOf(DomEventHandle)).call(this,emitter,event,listener));_this.capture_=capture;return _this;}
createClass(DomEventHandle,[{key:'removeListener',value:function removeListener(){this.emitter_.removeEventListener(this.event_,this.listener_,this.capture_);}}]);return DomEventHandle;}(EventHandle);var elementsByTag_={};var supportCache_={};var customEvents={};var LAST_CONTAINER='__metal_last_container__';var USE_CAPTURE={blur:true,error:true,focus:true,invalid:true,load:true,scroll:true};function addClasses(elements,classes){if(!isObject(elements)||!isString(classes)){return;}
if(!elements.length){elements=[elements];}
for(var i=0;i<elements.length;i++){if('classList'in elements[i]){addClassesWithNative_(elements[i],classes);}else{addClassesWithoutNative_(elements[i],classes);}}}
function addClassesWithNative_(element,classes){classes.split(' ').forEach(function(className){if(className){element.classList.add(className);}});}
function addClassesWithoutNative_(element,classes){var elementClassName=' '+element.className+' ';var classesToAppend='';classes=classes.split(' ');for(var i=0;i<classes.length;i++){var className=classes[i];if(elementClassName.indexOf(' '+className+' ')===-1){classesToAppend+=' '+className;}}
if(classesToAppend){element.className=element.className+classesToAppend;}}
function addElementListener_(element,eventName,listener){addToArr_(domData.get(element,'listeners',{}),eventName,listener);}
function addSelectorListener_(element,eventName,selector,listener){var delegatingData=domData.get(element,'delegating',{});addToArr_(delegatingData[eventName].selectors,selector,listener);}
function addToArr_(arr,key,value){if(!arr[key]){arr[key]=[];}
arr[key].push(value);}
function attachDelegateEvent_(element,eventName){var delegatingData=domData.get(element,'delegating',{});if(!delegatingData[eventName]){delegatingData[eventName]={handle:on(element,eventName,handleDelegateEvent_,!!USE_CAPTURE[eventName]),selectors:{}};}}
function closest(element,selector){while(element&&!match(element,selector)){element=element.parentNode;}
return element;}
function append(parent,child){if(isString(child)){child=buildFragment(child);}
if(isNodeListLike(child)){var childArr=Array.prototype.slice.call(child);for(var i=0;i<childArr.length;i++){parent.appendChild(childArr[i]);}}else{parent.appendChild(child);}
return child;}
function buildFragment(htmlString){var tempDiv=document.createElement('div');tempDiv.innerHTML='<br>'+htmlString;tempDiv.removeChild(tempDiv.firstChild);var fragment=document.createDocumentFragment();while(tempDiv.firstChild){fragment.appendChild(tempDiv.firstChild);}
return fragment;}
function contains(element1,element2){if(isDocument(element1)){return element1.documentElement.contains(element2);}else{return element1.contains(element2);}}
function delegate(element,eventName,selectorOrTarget,callback,defaultListener){var customConfig=customEvents[eventName];if(customConfig&&customConfig.delegate){eventName=customConfig.originalEvent;callback=customConfig.handler.bind(customConfig,callback);}
if(defaultListener){callback=callback.bind();callback.defaultListener_=true;}
attachDelegateEvent_(element,eventName);if(isString(selectorOrTarget)){addSelectorListener_(element,eventName,selectorOrTarget,callback);}else{addElementListener_(selectorOrTarget,eventName,callback);}
return new DomDelegatedEventHandle(isString(selectorOrTarget)?element:selectorOrTarget,eventName,callback,isString(selectorOrTarget)?selectorOrTarget:null);}
function isAbleToInteractWith_(node,eventName,eventObj){if(eventObj&&eventName==='click'&&eventObj.button===2){return false;}
var matchesSelector=['BUTTON','INPUT','SELECT','TEXTAREA','FIELDSET'];if(eventName==='click'&&matchesSelector.indexOf(node.tagName)>-1){return!(node.disabled||parent(node,'fieldset[disabled]'));}
return true;}
function isNodeListLike(val){return isDefAndNotNull(val)&&typeof val.length==='number'&&typeof val.item==='function';}
function exitDocument(node){if(node&&node.parentNode){node.parentNode.removeChild(node);}}
function handleDelegateEvent_(event){normalizeDelegateEvent_(event);var ret=true;var container=event.currentTarget;var defFns=[];ret&=triggerDelegatedListeners_(container,event,defFns);ret&=triggerDefaultDelegatedListeners_(defFns,event);event.delegateTarget=null;event[LAST_CONTAINER]=container;return ret;}
function match(element,selector){if(!element||element.nodeType!==1){return false;}
var p=Element.prototype;var m=p.matches||p.webkitMatchesSelector||p.mozMatchesSelector||p.msMatchesSelector||p.oMatchesSelector;if(m){return m.call(element,selector);}
return matchFallback_(element,selector);}
function matchFallback_(element,selector){var parentNode=element.parentNode;if(parentNode){var nodes=parentNode.querySelectorAll(selector);for(var i=0;i<nodes.length;++i){if(nodes[i]===element){return true;}}}
return false;}
function normalizeDelegateEvent_(event){event.stopPropagation=stopPropagation_;event.stopImmediatePropagation=stopImmediatePropagation_;}
function on(element,eventName,callback,capture){if(isString(element)){return delegate(document,eventName,element,callback);}
var customConfig=customEvents[eventName];if(customConfig&&customConfig.event){eventName=customConfig.originalEvent;callback=customConfig.handler.bind(customConfig,callback);}
element.addEventListener(eventName,callback,capture);return new DomEventHandle(element,eventName,callback,capture);}
function once(element,eventName,callback){var domEventHandle=on(element,eventName,function(){domEventHandle.removeListener();return callback.apply(this,arguments);});return domEventHandle;}
function parent(element,selector){return closest(element.parentNode,selector);}
function registerCustomEvent(eventName,customConfig){customEvents[eventName]=customConfig;}
function removeChildren(node){var child=void 0;while(child=node.firstChild){node.removeChild(child);}}
function removeClasses(elements,classes){if(!isObject(elements)||!isString(classes)){return;}
if(!elements.length){elements=[elements];}
for(var i=0;i<elements.length;i++){if('classList'in elements[i]){removeClassesWithNative_(elements[i],classes);}else{removeClassesWithoutNative_(elements[i],classes);}}}
function removeClassesWithNative_(element,classes){classes.split(' ').forEach(function(className){if(className){element.classList.remove(className);}});}
function removeClassesWithoutNative_(element,classes){var elementClassName=' '+element.className+' ';classes=classes.split(' ');for(var i=0;i<classes.length;i++){elementClassName=elementClassName.replace(' '+classes[i]+' ',' ');}
element.className=elementClassName.trim();}
function stopImmediatePropagation_(){var event=this;event.stopped=true;event.stoppedImmediate=true;Event.prototype.stopImmediatePropagation.call(event);}
function stopPropagation_(){var event=this;event.stopped=true;Event.prototype.stopPropagation.call(event);}
function supportsEvent(element,eventName){if(customEvents[eventName]){return true;}
if(isString(element)){if(!elementsByTag_[element]){elementsByTag_[element]=document.createElement(element);}
element=elementsByTag_[element];}
var tag=element.tagName;if(!supportCache_[tag]||!supportCache_[tag].hasOwnProperty(eventName)){supportCache_[tag]=supportCache_[tag]||{};supportCache_[tag][eventName]='on'+eventName in element;}
return supportCache_[tag][eventName];}
function triggerDefaultDelegatedListeners_(defFns,event){var ret=true;for(var i=0;i<defFns.length&&!event.defaultPrevented;i++){event.delegateTarget=defFns[i].element;ret&=defFns[i].fn(event);}
return ret;}
function triggerDelegatedListeners_(container,event,defaultFns){var ret=true;var currElement=event.target;var limit=container.parentNode;while(currElement&&currElement!==limit&&!event.stopped){if(isAbleToInteractWith_(currElement,event.type,event)){event.delegateTarget=currElement;ret&=triggerElementListeners_(currElement,event,defaultFns);ret&=triggerSelectorListeners_(container,currElement,event,defaultFns);}
currElement=currElement.parentNode;}
return ret;}
function triggerElementListeners_(element,event,defaultFns){var lastContainer=event[LAST_CONTAINER];if(!isDef(lastContainer)||!contains(lastContainer,element)){var listeners=domData.get(element,'listeners',{})[event.type];return triggerListeners_(listeners,event,element,defaultFns);}
return true;}
function triggerListeners_(listeners,event,element,defaultFns){var ret=true;listeners=listeners||[];for(var i=0;i<listeners.length&&!event.stoppedImmediate;i++){if(listeners[i].defaultListener_){defaultFns.push({element:element,fn:listeners[i]});}else{ret&=listeners[i](event);}}
return ret;}
function triggerSelectorListeners_(container,element,event,defaultFns){var ret=true;var data=domData.get(container,'delegating',{});var map=data[event.type].selectors;var selectors=Object.keys(map);for(var i=0;i<selectors.length&&!event.stoppedImmediate;i++){if(match(element,selectors[i])){var listeners=map[selectors[i]];ret&=triggerListeners_(listeners,event,element,defaultFns);}}
return ret;}
var DomEventEmitterProxy=function(_EventEmitterProxy){inherits(DomEventEmitterProxy,_EventEmitterProxy);function DomEventEmitterProxy(){classCallCheck(this,DomEventEmitterProxy);return possibleConstructorReturn(this,(DomEventEmitterProxy.__proto__||Object.getPrototypeOf(DomEventEmitterProxy)).apply(this,arguments));}
createClass(DomEventEmitterProxy,[{key:'addListener_',value:function addListener_(event,listener){if(this.originEmitter_.addEventListener){if(this.isDelegateEvent_(event)){var index=event.indexOf(':',9);var eventName=event.substring(9,index);var selector=event.substring(index+1);return delegate(this.originEmitter_,eventName,selector,listener);}else{return on(this.originEmitter_,event,listener);}}else{return get(DomEventEmitterProxy.prototype.__proto__||Object.getPrototypeOf(DomEventEmitterProxy.prototype),'addListener_',this).call(this,event,listener);}}},{key:'isDelegateEvent_',value:function isDelegateEvent_(event){return event.substr(0,9)==='delegate:';}},{key:'isSupportedDomEvent_',value:function isSupportedDomEvent_(event){if(!this.originEmitter_||!this.originEmitter_.addEventListener){return true;}
return this.isDelegateEvent_(event)&&event.indexOf(':',9)!==-1||supportsEvent(this.originEmitter_,event);}},{key:'shouldProxyEvent_',value:function shouldProxyEvent_(event){return get(DomEventEmitterProxy.prototype.__proto__||Object.getPrototypeOf(DomEventEmitterProxy.prototype),'shouldProxyEvent_',this).call(this,event)&&this.isSupportedDomEvent_(event);}}]);return DomEventEmitterProxy;}(EventEmitterProxy);var features=function(){function features(){classCallCheck(this,features);}
createClass(features,null,[{key:'checkAnimationEventName',value:function checkAnimationEventName(){if(features.animationEventName_===undefined){features.animationEventName_={animation:features.checkAnimationEventName_('animation'),transition:features.checkAnimationEventName_('transition')};}
return features.animationEventName_;}},{key:'checkAnimationEventName_',value:function checkAnimationEventName_(type){var prefixes=['Webkit','MS','O',''];var typeTitleCase=string.replaceInterval(type,0,1,type.substring(0,1).toUpperCase());var suffixes=[typeTitleCase+'End',typeTitleCase+'End',typeTitleCase+'End',type+'end'];if(!features.animationElement_){features.animationElement_=document.createElement('div');}
for(var i=0;i<prefixes.length;i++){if(features.animationElement_.style[prefixes[i]+typeTitleCase]!==undefined){return prefixes[i].toLowerCase()+suffixes[i];}}
return type+'end';}},{key:'checkAttrOrderChange',value:function checkAttrOrderChange(){if(features.attrOrderChange_===undefined){var originalContent='<div data-component="" data-ref=""></div>';var element=document.createElement('div');append(element,originalContent);features.attrOrderChange_=originalContent!==element.innerHTML;}
return features.attrOrderChange_;}}]);return features;}();features.animationElement_=undefined;features.animationEventName_=undefined;features.attrOrderChange_=undefined;var globalEval=function(){function globalEval(){classCallCheck(this,globalEval);}
createClass(globalEval,null,[{key:'run',value:function run(text,appendFn){var script=document.createElement('script');script.text=text;if(appendFn){appendFn(script);}else{document.head.appendChild(script);}
exitDocument(script);return script;}},{key:'runFile',value:function runFile(src,defaultFn,appendFn){var script=document.createElement('script');script.src=src;var callback=function callback(){exitDocument(script);defaultFn&&defaultFn();};once(script,'load',callback);once(script,'error',callback);if(appendFn){appendFn(script);}else{document.head.appendChild(script);}
return script;}},{key:'runScript',value:function runScript(script,defaultFn,appendFn){var callback=function callback(){defaultFn&&defaultFn();};if(script.type&&script.type!=='text/javascript'){async.nextTick(callback);return;}
exitDocument(script);if(script.src){return globalEval.runFile(script.src,defaultFn,appendFn);}else{async.nextTick(callback);return globalEval.run(script.text,appendFn);}}},{key:'runScriptsInElement',value:function runScriptsInElement(element,defaultFn,appendFn){var scripts=element.querySelectorAll('script');if(scripts.length){globalEval.runScriptsInOrder(scripts,0,defaultFn,appendFn);}else if(defaultFn){async.nextTick(defaultFn);}}},{key:'runScriptsInOrder',value:function runScriptsInOrder(scripts,index,defaultFn,appendFn){globalEval.runScript(scripts.item(index),function(){if(index<scripts.length-1){globalEval.runScriptsInOrder(scripts,index+1,defaultFn,appendFn);}else if(defaultFn){async.nextTick(defaultFn);}},appendFn);}}]);return globalEval;}();var globalEvalStyles=function(){function globalEvalStyles(){classCallCheck(this,globalEvalStyles);}
createClass(globalEvalStyles,null,[{key:'run',value:function run(text,appendFn){var style=document.createElement('style');style.innerHTML=text;if(appendFn){appendFn(style);}else{document.head.appendChild(style);}
return style;}},{key:'runFile',value:function runFile(href,defaultFn,appendFn){var link=document.createElement('link');link.rel='stylesheet';link.href=href;globalEvalStyles.runStyle(link,defaultFn,appendFn);return link;}},{key:'runStyle',value:function runStyle(style,defaultFn,appendFn){var callback=function callback(){defaultFn&&defaultFn();};if(style.rel&&style.rel!=='stylesheet'&&style.rel!=='canonical'&&style.rel!=='alternate'){async.nextTick(callback);return;}
if(style.tagName==='STYLE'||style.rel==='canonical'||style.rel==='alternate'){async.nextTick(callback);}else{once(style,'load',callback);once(style,'error',callback);}
if(appendFn){appendFn(style);}else{document.head.appendChild(style);}
return style;}},{key:'runStylesInElement',value:function runStylesInElement(element,defaultFn,appendFn){var styles=element.querySelectorAll('style,link');if(styles.length===0&&defaultFn){async.nextTick(defaultFn);return;}
var loadCount=0;var callback=function callback(){if(defaultFn&&++loadCount===styles.length){async.nextTick(defaultFn);}};for(var i=0;i<styles.length;i++){globalEvalStyles.runStyle(styles[i],callback,appendFn);}}}]);return globalEvalStyles;}();function registerEvents(){var mouseEventMap={mouseenter:'mouseover',mouseleave:'mouseout',pointerenter:'pointerover',pointerleave:'pointerout'};Object.keys(mouseEventMap).forEach(function(eventName){registerCustomEvent(eventName,{delegate:true,handler:function handler(callback,event){var related=event.relatedTarget;var target=event.delegateTarget;if(!related||related!==target&&!contains(target,related)){event.customType=eventName;return callback(event);}},originalEvent:mouseEventMap[eventName]});});var animationEventMap={animation:'animationend',transition:'transitionend'};Object.keys(animationEventMap).forEach(function(eventType){var eventName=animationEventMap[eventType];registerCustomEvent(eventName,{event:true,delegate:true,handler:function handler(callback,event){event.customType=eventName;return callback(event);},originalEvent:features.checkAnimationEventName()[eventType]});});}
if(!isServerSide()){registerEvents();}
var globals=globals||{};if(typeof window!=='undefined'){globals.window=window;}
if(typeof document!=='undefined'){globals.document=document;}
var compatibilityModeData_$1=void 0;var uniqueIdCounter_$1=1;var UID_PROPERTY$1='core_'+(Math.random()*1e9>>>0);function abstractMethod$1(){throw Error('Unimplemented abstract method');}
function disableCompatibilityMode$1(){compatibilityModeData_$1=undefined;}
function enableCompatibilityMode$1(){var data=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};compatibilityModeData_$1=data;}
function getCompatibilityModeData$1(){if(compatibilityModeData_$1===undefined){if(typeof window!=='undefined'&&window.__METAL_COMPATIBILITY__){enableCompatibilityMode$1(window.__METAL_COMPATIBILITY__);}}
return compatibilityModeData_$1;}
function getFirstTruthy_$1(a,b){return a||b;}
function getFunctionName$1(fn){if(!fn.name){var str=fn.toString();fn.name=str.substring(9,str.indexOf('('));}
return fn.name;}
function getStaticProperty$1(ctor,propertyName){var mergeFn=arguments.length>2&&arguments[2]!==undefined?arguments[2]:getFirstTruthy_$1;var mergedName=propertyName+'_MERGED';if(!ctor.hasOwnProperty(mergedName)){var merged=ctor.hasOwnProperty(propertyName)?ctor[propertyName]:null;if(ctor.__proto__&&!ctor.__proto__.isPrototypeOf(Function)){merged=mergeFn(merged,getStaticProperty$1(ctor.__proto__,propertyName,mergeFn));}
ctor[mergedName]=merged;}
return ctor[mergedName];}
function getUid$1(object,noInheritance){if(object){var id=object[UID_PROPERTY$1];if(noInheritance&&!object.hasOwnProperty(UID_PROPERTY$1)){id=null;}
return id||(object[UID_PROPERTY$1]=uniqueIdCounter_$1++);}
return uniqueIdCounter_$1++;}
function identityFunction$1(returnValue){return returnValue;}
function isBoolean$1(val){return typeof val==='boolean';}
function isDef$1(val){return val!==undefined;}
function isDefAndNotNull$1(val){return isDef$1(val)&&!isNull$1(val);}
function isDocument$1(val){return val&&(typeof val==='undefined'?'undefined':_typeof(val))==='object'&&val.nodeType===9;}
function isDocumentFragment$1(val){return val&&(typeof val==='undefined'?'undefined':_typeof(val))==='object'&&val.nodeType===11;}
function isElement$1(val){return val&&(typeof val==='undefined'?'undefined':_typeof(val))==='object'&&val.nodeType===1;}
function isFunction$1(val){return typeof val==='function';}
function isNull$1(val){return val===null;}
function isNumber$1(val){return typeof val==='number';}
function isWindow$1(val){return val!==null&&val===val.window;}
function isObject$1(val){var type=typeof val==='undefined'?'undefined':_typeof(val);return type==='object'&&val!==null||type==='function';}
function isPromise$1(val){return val&&(typeof val==='undefined'?'undefined':_typeof(val))==='object'&&typeof val.then==='function';}
function isString$1(val){return typeof val==='string'||val instanceof String;}
function isServerSide$1(){var options=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{checkEnv:true};var serverSide=typeof process!=='undefined'&&!process.browser;if(serverSide&&options.checkEnv){serverSide=typeof process.env!=='undefined'&&process.env.NODE_ENV!=='test';}
return serverSide;}
function nullFunction$1(){}
var core$4=Object.freeze({UID_PROPERTY:UID_PROPERTY$1,abstractMethod:abstractMethod$1,disableCompatibilityMode:disableCompatibilityMode$1,enableCompatibilityMode:enableCompatibilityMode$1,getCompatibilityModeData:getCompatibilityModeData$1,getFunctionName:getFunctionName$1,getStaticProperty:getStaticProperty$1,getUid:getUid$1,identityFunction:identityFunction$1,isBoolean:isBoolean$1,isDef:isDef$1,isDefAndNotNull:isDefAndNotNull$1,isDocument:isDocument$1,isDocumentFragment:isDocumentFragment$1,isElement:isElement$1,isFunction:isFunction$1,isNull:isNull$1,isNumber:isNumber$1,isWindow:isWindow$1,isObject:isObject$1,isPromise:isPromise$1,isString:isString$1,isServerSide:isServerSide$1,nullFunction:nullFunction$1});var array$2=function(){function array(){classCallCheck(this,array);}
createClass(array,null,[{key:'equal',value:function equal(arr1,arr2){if(arr1===arr2){return true;}
if(arr1.length!==arr2.length){return false;}
for(var i=0;i<arr1.length;i++){if(arr1[i]!==arr2[i]){return false;}}
return true;}},{key:'firstDefinedValue',value:function firstDefinedValue(arr){for(var i=0;i<arr.length;i++){if(arr[i]!==undefined){return arr[i];}}}},{key:'flatten',value:function flatten(arr){var output=arguments.length>1&&arguments[1]!==undefined?arguments[1]:[];for(var i=0;i<arr.length;i++){if(Array.isArray(arr[i])){array.flatten(arr[i],output);}else{output.push(arr[i]);}}
return output;}},{key:'remove',value:function remove(arr,obj){var i=arr.indexOf(obj);var rv=void 0;if(rv=i>=0){array.removeAt(arr,i);}
return rv;}},{key:'removeAt',value:function removeAt(arr,i){return Array.prototype.splice.call(arr,i,1).length===1;}},{key:'slice',value:function slice(arr,start){var end=arguments.length>2&&arguments[2]!==undefined?arguments[2]:arr.length;var sliced=[];for(var i=start;i<end;i++){sliced.push(arr[i]);}
return sliced;}}]);return array;}();var async$2={};async$2.throwException=function(exception){async$2.nextTick(function(){throw exception;});};async$2.run=function(callback,context){if(!async$2.run.workQueueScheduled_){async$2.nextTick(async$2.run.processWorkQueue);async$2.run.workQueueScheduled_=true;}
async$2.run.workQueue_.push(new async$2.run.WorkItem_(callback,context));};async$2.run.workQueueScheduled_=false;async$2.run.workQueue_=[];async$2.run.processWorkQueue=function(){while(async$2.run.workQueue_.length){var workItems=async$2.run.workQueue_;async$2.run.workQueue_=[];for(var i=0;i<workItems.length;i++){var workItem=workItems[i];try{workItem.fn.call(workItem.scope);}catch(e){async$2.throwException(e);}}}
async$2.run.workQueueScheduled_=false;};async$2.run.WorkItem_=function(fn,scope){this.fn=fn;this.scope=scope;};async$2.nextTick=function(callback,context){var cb=callback;if(context){cb=callback.bind(context);}
cb=async$2.nextTick.wrapCallback_(cb);if(!async$2.nextTick.setImmediate_){if(typeof setImmediate==='function'&&isServerSide$1({checkEnv:false})){async$2.nextTick.setImmediate_=setImmediate;}else{async$2.nextTick.setImmediate_=async$2.nextTick.getSetImmediateEmulator_();}}
async$2.nextTick.setImmediate_(cb);};async$2.nextTick.setImmediate_=null;async$2.nextTick.getSetImmediateEmulator_=function(){var Channel=void 0;if(typeof MessageChannel==='function'){Channel=MessageChannel;}
if(typeof Channel==='undefined'&&typeof window!=='undefined'&&window.postMessage&&window.addEventListener){Channel=function Channel(){var iframe=document.createElement('iframe');iframe.style.display='none';iframe.src='';iframe.title='';document.documentElement.appendChild(iframe);var win=iframe.contentWindow;var doc=win.document;doc.open();doc.write('');doc.close();var message='callImmediate'+Math.random();var origin=win.location.protocol+'//'+win.location.host;var onmessage=function(e){if(e.origin!==origin&&e.data!==message){return;}
this.port1.onmessage();}.bind(this);win.addEventListener('message',onmessage,false);this.port1={};this.port2={postMessage:function postMessage(){win.postMessage(message,origin);}};};}
if(typeof Channel!=='undefined'){var channel=new Channel();var head={};var tail=head;channel.port1.onmessage=function(){head=head.next;var cb=head.cb;head.cb=null;cb();};return function(cb){tail.next={cb:cb};tail=tail.next;channel.port2.postMessage(0);};}
if(typeof document!=='undefined'&&'onreadystatechange'in document.createElement('script')){return function(cb){var script=document.createElement('script');script.onreadystatechange=function(){script.onreadystatechange=null;script.parentNode.removeChild(script);script=null;cb();cb=null;};document.documentElement.appendChild(script);};}
return function(cb){setTimeout(cb,0);};};async$2.nextTick.wrapCallback_=function(callback){return callback;};var Disposable$2=function(){function Disposable(){classCallCheck(this,Disposable);this.disposed_=false;}
createClass(Disposable,[{key:'dispose',value:function dispose(){if(!this.disposed_){this.disposeInternal();this.disposed_=true;}}},{key:'disposeInternal',value:function disposeInternal(){}},{key:'isDisposed',value:function isDisposed(){return this.disposed_;}}]);return Disposable;}();var object$2=function(){function object(){classCallCheck(this,object);}
createClass(object,null,[{key:'mixin',value:function mixin(target){var key=void 0;var source=void 0;for(var _len=arguments.length,args=Array(_len>1?_len-1:0),_key=1;_key<_len;_key++){args[_key-1]=arguments[_key];}
for(var i=0;i<args.length;i++){source=args[i];for(key in source){target[key]=source[key];}}
return target;}},{key:'getObjectByName',value:function getObjectByName(name){var scope=arguments.length>1&&arguments[1]!==undefined?arguments[1]:window;var parts=name.split('.');return parts.reduce(function(part,key){return part[key];},scope);}},{key:'map',value:function map(obj,fn){var mappedObj={};var keys=Object.keys(obj);for(var i=0;i<keys.length;i++){mappedObj[keys[i]]=fn(keys[i],obj[keys[i]]);}
return mappedObj;}},{key:'shallowEqual',value:function shallowEqual(obj1,obj2){if(obj1===obj2){return true;}
var keys1=Object.keys(obj1);var keys2=Object.keys(obj2);if(keys1.length!==keys2.length){return false;}
for(var i=0;i<keys1.length;i++){if(obj1[keys1[i]]!==obj2[keys1[i]]){return false;}}
return true;}}]);return object;}();var string$2=function(){function string(){classCallCheck(this,string);}
createClass(string,null,[{key:'caseInsensitiveCompare',value:function caseInsensitiveCompare(str1,str2){var test1=String(str1).toLowerCase();var test2=String(str2).toLowerCase();if(test1<test2){return-1;}else if(test1===test2){return 0;}else{return 1;}}},{key:'collapseBreakingSpaces',value:function collapseBreakingSpaces(str){return str.replace(/[\t\r\n ]+/g,' ').replace(/^[\t\r\n ]+|[\t\r\n ]+$/g,'');}},{key:'escapeRegex',value:function escapeRegex(str){return String(str).replace(/([-()[\]{}+?*.$^|,:#<!\\])/g,'\\$1').replace(/\x08/g,'\\x08');}},{key:'getRandomString',value:function getRandomString(){var x=2147483648;return Math.floor(Math.random()*x).toString(36)+Math.abs(Math.floor(Math.random()*x)^Date.now()).toString(36);}},{key:'hashCode',value:function hashCode(val){var hash=0;for(var i=0,len=val.length;i<len;i++){hash=31*hash+val.charCodeAt(i);hash%=0x100000000;}
return hash;}},{key:'replaceInterval',value:function replaceInterval(str,start,end,value){return str.substring(0,start)+value+str.substring(end);}}]);return string;}();function parseFromAnchor(opt_uri){var link=document.createElement('a');link.href=opt_uri;if(link.protocol===':'||!/:/.test(link.href)){throw new TypeError(opt_uri+' is not a valid URL');}
return{hash:link.hash,hostname:link.hostname,password:link.password,pathname:link.pathname[0]==='/'?link.pathname:'/'+link.pathname,port:link.port,protocol:link.protocol,search:link.search,username:link.username};}
function parse(opt_uri){if(isFunction$1(URL)&&URL.length){var url=new URL(opt_uri);if(url.port&&url.href.indexOf(url.port)===-1){throw new TypeError(opt_uri+' is not a valid URL');}
return url;}else{return parseFromAnchor(opt_uri);}}
var create=Object.create;var MultiMap=function(_Disposable){inherits(MultiMap,_Disposable);function MultiMap(){classCallCheck(this,MultiMap);var _this=possibleConstructorReturn(this,(MultiMap.__proto__||Object.getPrototypeOf(MultiMap)).call(this));_this.keys=create(null);_this.values=create(null);return _this;}
createClass(MultiMap,[{key:'add',value:function add(name,value){this.keys[name.toLowerCase()]=name;this.values[name.toLowerCase()]=this.values[name.toLowerCase()]||[];this.values[name.toLowerCase()].push(value);return this;}},{key:'clear',value:function clear(){this.keys=create(null);this.values=create(null);return this;}},{key:'contains',value:function contains(name){return name.toLowerCase()in this.values;}},{key:'disposeInternal',value:function disposeInternal(){this.values=null;}},{key:'get',value:function get$$1(name){var values=this.values[name.toLowerCase()];if(values){return values[0];}}},{key:'getAll',value:function getAll(name){return this.values[name.toLowerCase()];}},{key:'isEmpty',value:function isEmpty(){return this.size()===0;}},{key:'names',value:function names(){var _this2=this;return Object.keys(this.values).map(function(key){return _this2.keys[key];});}},{key:'remove',value:function remove(name){delete this.keys[name.toLowerCase()];delete this.values[name.toLowerCase()];return this;}},{key:'set',value:function set$$1(name,value){this.keys[name.toLowerCase()]=name;this.values[name.toLowerCase()]=[value];return this;}},{key:'size',value:function size(){return this.names().length;}},{key:'toString',value:function toString(){return JSON.stringify(this.values);}}],[{key:'fromObject',value:function fromObject(obj){var map=new MultiMap();var keys=Object.keys(obj);for(var i=0;i<keys.length;i++){map.set(keys[i],obj[keys[i]]);}
return map;}}]);return MultiMap;}(Disposable$2);var TreeNode=function(){function TreeNode(value){classCallCheck(this,TreeNode);this.value_=value;this.parent_=null;this.children_=null;}
createClass(TreeNode,[{key:'addChild',value:function addChild(child){assertChildHasNoParent(child);child.setParent(this);this.children_=this.children_||[];this.children_.push(child);}},{key:'contains',value:function contains(node){var current=node.getParent();while(current){if(current===this){return true;}
current=current.getParent();}
return false;}},{key:'getAncestors',value:function getAncestors(){var ancestors=[];var node=this.getParent();while(node){ancestors.push(node);node=node.getParent();}
return ancestors;}},{key:'getChildAt',value:function getChildAt(index){return this.getChildren()[index]||null;}},{key:'getChildren',value:function getChildren(){return this.children_||TreeNode.EMPTY_ARRAY;}},{key:'getChildCount',value:function getChildCount(){return this.getChildren().length;}},{key:'getDepth',value:function getDepth(){var depth=0;var node=this;while(node.getParent()){depth++;node=node.getParent();}
return depth;}},{key:'getParent',value:function getParent(){return this.parent_;}},{key:'getRoot',value:function getRoot(){var root=this;while(root.getParent()){root=root.getParent();}
return root;}},{key:'getValue',value:function getValue(){return this.value_;}},{key:'isLeaf',value:function isLeaf(){return!this.getChildCount();}},{key:'removeChild',value:function removeChild(child){if(array$2.remove(this.getChildren(),child)){return child;}
return null;}},{key:'setParent',value:function setParent(parent){this.parent_=parent;}},{key:'traverse',value:function traverse(opt_preorderFn,opt_postorderFn){if(opt_preorderFn){opt_preorderFn(this);}
this.getChildren().forEach(function(child){return child.traverse(opt_preorderFn,opt_postorderFn);});if(opt_postorderFn){opt_postorderFn(this);}}}]);return TreeNode;}();TreeNode.EMPTY_ARRAY=[];var assertChildHasNoParent=function assertChildHasNoParent(child){if(child.getParent()){throw new Error('Cannot add child with parent.');}};var parseFn_=parse;var Uri=function(){function Uri(){var opt_uri=arguments.length>0&&arguments[0]!==undefined?arguments[0]:'';classCallCheck(this,Uri);this.url=Uri.parse(this.maybeAddProtocolAndHostname_(opt_uri));}
createClass(Uri,[{key:'addParametersFromMultiMap',value:function addParametersFromMultiMap(multimap){var _this=this;multimap.names().forEach(function(name){multimap.getAll(name).forEach(function(value){_this.addParameterValue(name,value);});});return this;}},{key:'addParameterValue',value:function addParameterValue(name,value){this.ensureQueryInitialized_();if(isDef$1(value)){value=String(value);}
this.query.add(name,value);return this;}},{key:'addParameterValues',value:function addParameterValues(name,values){var _this2=this;values.forEach(function(value){return _this2.addParameterValue(name,value);});return this;}},{key:'ensureQueryInitialized_',value:function ensureQueryInitialized_(){var _this3=this;if(this.query){return;}
this.query=new MultiMap();var search=this.url.search;if(search){search.substring(1).split('&').forEach(function(param){var _param$split=param.split('='),_param$split2=slicedToArray(_param$split,2),key=_param$split2[0],value=_param$split2[1];if(isDef$1(value)){value=Uri.urlDecode(value);}
_this3.addParameterValue(key,value);});}}},{key:'getHash',value:function getHash(){return this.url.hash||'';}},{key:'getHost',value:function getHost(){var host=this.getHostname();if(host){var port=this.getPort();if(port&&port!=='80'){host+=':'+port;}}
return host;}},{key:'getHostname',value:function getHostname(){var hostname=this.url.hostname;if(hostname===Uri.HOSTNAME_PLACEHOLDER){return'';}
return hostname;}},{key:'getOrigin',value:function getOrigin(){var host=this.getHost();if(host){return this.getProtocol()+'//'+host;}
return'';}},{key:'getParameterValue',value:function getParameterValue(name){this.ensureQueryInitialized_();return this.query.get(name);}},{key:'getParameterValues',value:function getParameterValues(name){this.ensureQueryInitialized_();return this.query.getAll(name);}},{key:'getParameterNames',value:function getParameterNames(){this.ensureQueryInitialized_();return this.query.names();}},{key:'getPathname',value:function getPathname(){return this.url.pathname;}},{key:'getPort',value:function getPort(){return this.url.port;}},{key:'getProtocol',value:function getProtocol(){return this.url.protocol;}},{key:'getSearch',value:function getSearch(){var _this4=this;var search='';var querystring='';this.getParameterNames().forEach(function(name){_this4.getParameterValues(name).forEach(function(value){querystring+=name;if(isDef$1(value)){querystring+='='+encodeURIComponent(value);}
querystring+='&';});});querystring=querystring.slice(0,-1);if(querystring){search+='?'+querystring;}
return search;}},{key:'hasParameter',value:function hasParameter(name){this.ensureQueryInitialized_();return this.query.contains(name);}},{key:'makeUnique',value:function makeUnique(){this.setParameterValue(Uri.RANDOM_PARAM,string$2.getRandomString());return this;}},{key:'maybeAddProtocolAndHostname_',value:function maybeAddProtocolAndHostname_(opt_uri){var url=opt_uri;if(opt_uri.indexOf('://')===-1&&opt_uri.indexOf('javascript:')!==0){url=Uri.DEFAULT_PROTOCOL;if(opt_uri[0]!=='/'||opt_uri[1]!=='/'){url+='//';}
switch(opt_uri.charAt(0)){case'.':case'?':case'#':url+=Uri.HOSTNAME_PLACEHOLDER;url+='/';url+=opt_uri;break;case'':case'/':if(opt_uri[1]!=='/'){url+=Uri.HOSTNAME_PLACEHOLDER;}
url+=opt_uri;break;default:url+=opt_uri;}}
return url;}},{key:'removeParameter',value:function removeParameter(name){this.ensureQueryInitialized_();this.query.remove(name);return this;}},{key:'removeUnique',value:function removeUnique(){this.removeParameter(Uri.RANDOM_PARAM);return this;}},{key:'setHash',value:function setHash(hash){this.url.hash=hash;return this;}},{key:'setHostname',value:function setHostname(hostname){this.url.hostname=hostname;return this;}},{key:'setParameterValue',value:function setParameterValue(name,value){this.removeParameter(name);this.addParameterValue(name,value);return this;}},{key:'setParameterValues',value:function setParameterValues(name,values){var _this5=this;this.removeParameter(name);values.forEach(function(value){return _this5.addParameterValue(name,value);});return this;}},{key:'setPathname',value:function setPathname(pathname){this.url.pathname=pathname;return this;}},{key:'setPort',value:function setPort(port){this.url.port=port;return this;}},{key:'setProtocol',value:function setProtocol(protocol){this.url.protocol=protocol;if(this.url.protocol[this.url.protocol.length-1]!==':'){this.url.protocol+=':';}
return this;}},{key:'toString',value:function toString(){var href='';var host=this.getHost();if(host){href+=this.getProtocol()+'//';}
href+=host+this.getPathname()+this.getSearch()+this.getHash();return href;}}],[{key:'getParseFn',value:function getParseFn(){return parseFn_;}},{key:'parse',value:function parse$$1(opt_uri){return parseFn_(opt_uri);}},{key:'setParseFn',value:function setParseFn(parseFn){parseFn_=parseFn;}},{key:'joinPaths',value:function joinPaths(basePath){for(var _len=arguments.length,paths=Array(_len>1?_len-1:0),_key=1;_key<_len;_key++){paths[_key-1]=arguments[_key];}
if(basePath.charAt(basePath.length-1)==='/'){basePath=basePath.substring(0,basePath.length-1);}
paths=paths.map(function(path){return path.charAt(0)==='/'?path.substring(1):path;});return[basePath].concat(paths).join('/').replace(/\/$/,'');}},{key:'urlDecode',value:function urlDecode(str){return decodeURIComponent(str.replace(/\+/g,' '));}}]);return Uri;}();var isSecure=function isSecure(){return typeof window!=='undefined'&&window.location&&window.location.protocol&&window.location.protocol.indexOf('https')===0;};Uri.DEFAULT_PROTOCOL=isSecure()?'https:':'http:';Uri.HOSTNAME_PLACEHOLDER='hostname'+Date.now();Uri.RANDOM_PARAM='zx';var utils=function(){function utils(){classCallCheck(this,utils);}
createClass(utils,null,[{key:'copyNodeAttributes',value:function copyNodeAttributes(source,target){Array.prototype.slice.call(source.attributes).forEach(function(attribute){return target.setAttribute(attribute.name,attribute.value);});}},{key:'getCurrentBrowserPath',value:function getCurrentBrowserPath(){return this.getCurrentBrowserPathWithoutHash()+globals.window.location.hash;}},{key:'getCurrentBrowserPathWithoutHash',value:function getCurrentBrowserPathWithoutHash(){return globals.window.location.pathname+globals.window.location.search;}},{key:'getNodeOffset',value:function getNodeOffset(node){var offsetLeft=0,offsetTop=0;do{offsetLeft+=node.offsetLeft;offsetTop+=node.offsetTop;node=node.offsetParent;}while(node);return{offsetLeft:offsetLeft,offsetTop:offsetTop};}},{key:'getUrlPath',value:function getUrlPath(url){var uri=new Uri(url);return uri.getPathname()+uri.getSearch()+uri.getHash();}},{key:'getUrlPathWithoutHash',value:function getUrlPathWithoutHash(url){var uri=new Uri(url);return uri.getPathname()+uri.getSearch();}},{key:'getUrlPathWithoutHashAndSearch',value:function getUrlPathWithoutHashAndSearch(url){var uri=new Uri(url);return uri.getPathname();}},{key:'isCurrentBrowserPath',value:function isCurrentBrowserPath(url){if(url){var currentBrowserPath=this.getCurrentBrowserPathWithoutHash();return utils.getUrlPathWithoutHash(url)===this.getUrlPath(currentBrowserPath);}
return false;}},{key:'isHtml5HistorySupported',value:function isHtml5HistorySupported(){return!!(globals.window.history&&globals.window.history.pushState);}},{key:'isWebUri',value:function isWebUri(url){try{return new Uri(url);}catch(err){console.error(err.message+' '+url);return false;}}},{key:'clearNodeAttributes',value:function clearNodeAttributes(node){Array.prototype.slice.call(node.attributes).forEach(function(attribute){return node.removeAttribute(attribute.name);});}},{key:'removeElementsFromDocument',value:function removeElementsFromDocument(elements){elements.forEach(function(element){return exitDocument(element);});}},{key:'removePathTrailingSlash',value:function removePathTrailingSlash(path){var length=path?path.length:0;if(length>1&&path[length-1]==='/'){path=path.substr(0,length-1);}
return path;}},{key:'setElementWithRandomHref',value:function setElementWithRandomHref(element){element.href=element.href+'?q='+Math.random();return element;}},{key:'setReferrer',value:function setReferrer(referrer){Object.defineProperty(globals.document,'referrer',{configurable:true,get:function get$$1(){return referrer;}});}}]);return utils;}();var dataAttributes={basePath:'data-senna-base-path',linkSelector:'data-senna-link-selector',loadingCssClass:'data-senna-loading-css-class',senna:'data-senna',dispatch:'data-senna-dispatch',surface:'data-senna-surface',updateScrollPosition:'data-senna-update-scroll-position'};var EventHandle$2=function(_Disposable){inherits(EventHandle,_Disposable);function EventHandle(emitter,event,listener){classCallCheck(this,EventHandle);var _this=possibleConstructorReturn(this,(EventHandle.__proto__||Object.getPrototypeOf(EventHandle)).call(this));_this.emitter_=emitter;_this.event_=event;_this.listener_=listener;return _this;}
createClass(EventHandle,[{key:'disposeInternal',value:function disposeInternal(){this.removeListener();this.emitter_=null;this.listener_=null;}},{key:'removeListener',value:function removeListener(){if(!this.emitter_.isDisposed()){this.emitter_.removeListener(this.event_,this.listener_);}}}]);return EventHandle;}(Disposable$2);var singleArray_$1=[0];var EventEmitter$4=function(_Disposable){inherits(EventEmitter,_Disposable);function EventEmitter(){classCallCheck(this,EventEmitter);var _this=possibleConstructorReturn(this,(EventEmitter.__proto__||Object.getPrototypeOf(EventEmitter)).call(this));_this.events_=null;_this.listenerHandlers_=null;_this.shouldUseFacade_=false;return _this;}
createClass(EventEmitter,[{key:'addHandler_',value:function addHandler_(holder,handler){if(!holder){holder=handler;}else{if(!Array.isArray(holder)){holder=[holder];}
holder.push(handler);}
return holder;}},{key:'addListener',value:function addListener(event,listener,defaultListener){this.validateListener_(listener);var events=this.toEventsArray_(event);for(var i=0;i<events.length;i++){this.addSingleListener_(events[i],listener,defaultListener);}
return new EventHandle$2(this,event,listener);}},{key:'addSingleListener_',value:function addSingleListener_(event,listener,defaultListener,origin){this.runListenerHandlers_(event);if(defaultListener||origin){listener={default:defaultListener,fn:listener,origin:origin};}
this.events_=this.events_||{};this.events_[event]=this.addHandler_(this.events_[event],listener);}},{key:'buildFacade_',value:function buildFacade_(event){if(this.getShouldUseFacade()){var facade={preventDefault:function preventDefault(){facade.preventedDefault=true;},target:this,type:event};return facade;}}},{key:'disposeInternal',value:function disposeInternal(){this.events_=null;}},{key:'emit',value:function emit(event){var listeners=this.getRawListeners_(event);if(listeners.length===0){return false;}
var args=array$2.slice(arguments,1);this.runListeners_(listeners,args,this.buildFacade_(event));return true;}},{key:'getRawListeners_',value:function getRawListeners_(event){var directListeners=toArray$2(this.events_&&this.events_[event]);return directListeners.concat(toArray$2(this.events_&&this.events_['*']));}},{key:'getShouldUseFacade',value:function getShouldUseFacade(){return this.shouldUseFacade_;}},{key:'listeners',value:function listeners(event){return this.getRawListeners_(event).map(function(listener){return listener.fn?listener.fn:listener;});}},{key:'many',value:function many(event,amount,listener){var events=this.toEventsArray_(event);for(var i=0;i<events.length;i++){this.many_(events[i],amount,listener);}
return new EventHandle$2(this,event,listener);}},{key:'many_',value:function many_(event,amount,listener){var self=this;if(amount<=0){return;}
function handlerInternal(){if(--amount===0){self.removeListener(event,handlerInternal);}
listener.apply(self,arguments);}
self.addSingleListener_(event,handlerInternal,false,listener);}},{key:'matchesListener_',value:function matchesListener_(listenerObj,listener){var fn=listenerObj.fn||listenerObj;return fn===listener||listenerObj.origin&&listenerObj.origin===listener;}},{key:'off',value:function off(event,listener){this.validateListener_(listener);if(!this.events_){return this;}
var events=this.toEventsArray_(event);for(var i=0;i<events.length;i++){this.events_[events[i]]=this.removeMatchingListenerObjs_(toArray$2(this.events_[events[i]]),listener);}
return this;}},{key:'on',value:function on(){return this.addListener.apply(this,arguments);}},{key:'onListener',value:function onListener(handler){this.listenerHandlers_=this.addHandler_(this.listenerHandlers_,handler);}},{key:'once',value:function once(events,listener){return this.many(events,1,listener);}},{key:'removeAllListeners',value:function removeAllListeners(event){if(this.events_){if(event){var events=this.toEventsArray_(event);for(var i=0;i<events.length;i++){this.events_[events[i]]=null;}}else{this.events_=null;}}
return this;}},{key:'removeMatchingListenerObjs_',value:function removeMatchingListenerObjs_(listenerObjs,listener){var finalListeners=[];for(var i=0;i<listenerObjs.length;i++){if(!this.matchesListener_(listenerObjs[i],listener)){finalListeners.push(listenerObjs[i]);}}
return finalListeners.length>0?finalListeners:null;}},{key:'removeListener',value:function removeListener(){return this.off.apply(this,arguments);}},{key:'runListenerHandlers_',value:function runListenerHandlers_(event){var handlers=this.listenerHandlers_;if(handlers){handlers=toArray$2(handlers);for(var i=0;i<handlers.length;i++){handlers[i](event);}}}},{key:'runListeners_',value:function runListeners_(listeners,args,facade){if(facade){args.push(facade);}
var defaultListeners=[];for(var i=0;i<listeners.length;i++){var listener=listeners[i].fn||listeners[i];if(listeners[i].default){defaultListeners.push(listener);}else{listener.apply(this,args);}}
if(!facade||!facade.preventedDefault){for(var j=0;j<defaultListeners.length;j++){defaultListeners[j].apply(this,args);}}}},{key:'setShouldUseFacade',value:function setShouldUseFacade(shouldUseFacade){this.shouldUseFacade_=shouldUseFacade;return this;}},{key:'toEventsArray_',value:function toEventsArray_(events){if(isString$1(events)){singleArray_$1[0]=events;events=singleArray_$1;}
return events;}},{key:'validateListener_',value:function validateListener_(listener){if(!isFunction$1(listener)){throw new TypeError('Listener must be a function');}}}]);return EventEmitter;}(Disposable$2);function toArray$2(val){val=val||[];return Array.isArray(val)?val:[val];}
var EventEmitterProxy$2=function(_Disposable){inherits(EventEmitterProxy,_Disposable);function EventEmitterProxy(originEmitter,targetEmitter,blacklist,whitelist){classCallCheck(this,EventEmitterProxy);var _this=possibleConstructorReturn(this,(EventEmitterProxy.__proto__||Object.getPrototypeOf(EventEmitterProxy)).call(this));_this.blacklist_=blacklist;_this.originEmitter_=originEmitter;_this.pendingEvents_=null;_this.proxiedEvents_=null;_this.targetEmitter_=targetEmitter;_this.whitelist_=whitelist;_this.startProxy_();return _this;}
createClass(EventEmitterProxy,[{key:'addListener_',value:function addListener_(event,listener){return this.originEmitter_.on(event,listener);}},{key:'disposeInternal',value:function disposeInternal(){this.removeListeners_();this.proxiedEvents_=null;this.originEmitter_=null;this.targetEmitter_=null;}},{key:'emitOnTarget_',value:function emitOnTarget_(){var _targetEmitter_;(_targetEmitter_=this.targetEmitter_).emit.apply(_targetEmitter_,arguments);}},{key:'proxyEvent',value:function proxyEvent(event){if(this.shouldProxyEvent_(event)){this.tryToAddListener_(event);}}},{key:'removeListeners_',value:function removeListeners_(){if(this.proxiedEvents_){var events=Object.keys(this.proxiedEvents_);for(var i=0;i<events.length;i++){this.proxiedEvents_[events[i]].removeListener();}
this.proxiedEvents_=null;}
this.pendingEvents_=null;}},{key:'setOriginEmitter',value:function setOriginEmitter(originEmitter){var _this2=this;var events=this.originEmitter_&&this.proxiedEvents_?Object.keys(this.proxiedEvents_):this.pendingEvents_;this.originEmitter_=originEmitter;if(events){this.removeListeners_();events.forEach(function(event){return _this2.proxyEvent(event);});}}},{key:'shouldProxyEvent_',value:function shouldProxyEvent_(event){if(this.whitelist_&&!this.whitelist_[event]){return false;}
if(this.blacklist_&&this.blacklist_[event]){return false;}
return!this.proxiedEvents_||!this.proxiedEvents_[event];}},{key:'startProxy_',value:function startProxy_(){this.targetEmitter_.onListener(this.proxyEvent.bind(this));}},{key:'tryToAddListener_',value:function tryToAddListener_(event){if(this.originEmitter_){this.proxiedEvents_=this.proxiedEvents_||{};this.proxiedEvents_[event]=this.addListener_(event,this.emitOnTarget_.bind(this,event));}else{this.pendingEvents_=this.pendingEvents_||[];this.pendingEvents_.push(event);}}}]);return EventEmitterProxy;}(Disposable$2);var EventHandler$2=function(_Disposable){inherits(EventHandler,_Disposable);function EventHandler(){classCallCheck(this,EventHandler);var _this=possibleConstructorReturn(this,(EventHandler.__proto__||Object.getPrototypeOf(EventHandler)).call(this));_this.eventHandles_=[];return _this;}
createClass(EventHandler,[{key:'add',value:function add(){for(var _len=arguments.length,args=Array(_len),_key=0;_key<_len;_key++){args[_key]=arguments[_key];}
for(var i=0;i<arguments.length;i++){this.eventHandles_.push(args[i]);}}},{key:'disposeInternal',value:function disposeInternal(){this.eventHandles_=null;}},{key:'removeAllListeners',value:function removeAllListeners(){for(var i=0;i<this.eventHandles_.length;i++){this.eventHandles_[i].removeListener();}
this.eventHandles_=[];}}]);return EventHandler;}(Disposable$2);var Thenable=function Thenable(){};Thenable.prototype.then=function(){};Thenable.IMPLEMENTED_BY_PROP='$goog_Thenable';Thenable.addImplementation=function(ctor){ctor.prototype.then=ctor.prototype.then;ctor.prototype.$goog_Thenable=true;};Thenable.isImplementedBy=function(object){if(!object){return false;}
try{return!!object.$goog_Thenable;}catch(e){return false;}};var partial=function partial(fn){var args=Array.prototype.slice.call(arguments,1);return function(){var newArgs=args.slice();newArgs.push.apply(newArgs,arguments);return fn.apply(this,newArgs);};};var CancellablePromise=function CancellablePromise(resolver,opt_context){this.state_=CancellablePromise.State_.PENDING;this.result_=undefined;this.parent_=null;this.callbackEntries_=null;this.executing_=false;if(CancellablePromise.UNHANDLED_REJECTION_DELAY>0){this.unhandledRejectionId_=0;}else if(CancellablePromise.UNHANDLED_REJECTION_DELAY===0){this.hadUnhandledRejection_=false;}
try{var self=this;resolver.call(opt_context,function(value){self.resolve_(CancellablePromise.State_.FULFILLED,value);},function(reason){self.resolve_(CancellablePromise.State_.REJECTED,reason);});}catch(e){this.resolve_(CancellablePromise.State_.REJECTED,e);}};CancellablePromise.UNHANDLED_REJECTION_DELAY=0;CancellablePromise.State_={PENDING:0,BLOCKED:1,FULFILLED:2,REJECTED:3};CancellablePromise.CallbackEntry_=null;CancellablePromise.resolve=function(opt_value){return new CancellablePromise(function(resolve){resolve(opt_value);});};CancellablePromise.reject=function(opt_reason){return new CancellablePromise(function(resolve,reject){reject(opt_reason);});};CancellablePromise.race=function(promises){return new CancellablePromise(function(resolve,reject){if(!promises.length){resolve(undefined);}
for(var i=0,promise;promise=promises[i];i++){promise.then(resolve,reject);}});};CancellablePromise.all=function(promises){return new CancellablePromise(function(resolve,reject){var toFulfill=promises.length;var values=[];if(!toFulfill){resolve(values);return;}
var onFulfill=function onFulfill(index,value){toFulfill--;values[index]=value;if(toFulfill===0){resolve(values);}};var onReject=function onReject(reason){reject(reason);};for(var i=0,promise;promise=promises[i];i++){promise.then(partial(onFulfill,i),onReject);}});};CancellablePromise.firstFulfilled=function(promises){return new CancellablePromise(function(resolve,reject){var toReject=promises.length;var reasons=[];if(!toReject){resolve(undefined);return;}
var onFulfill=function onFulfill(value){resolve(value);};var onReject=function onReject(index,reason){toReject--;reasons[index]=reason;if(toReject===0){reject(reasons);}};for(var i=0,promise;promise=promises[i];i++){promise.then(onFulfill,partial(onReject,i));}});};CancellablePromise.prototype.then=function(opt_onFulfilled,opt_onRejected,opt_context){return this.addChildPromise_(isFunction$1(opt_onFulfilled)?opt_onFulfilled:null,isFunction$1(opt_onRejected)?opt_onRejected:null,opt_context);};Thenable.addImplementation(CancellablePromise);CancellablePromise.prototype.thenAlways=function(onResolved,opt_context){var callback=function callback(){try{onResolved.call(opt_context);}catch(err){CancellablePromise.handleRejection_.call(null,err);}};this.addCallbackEntry_({child:null,onRejected:callback,onFulfilled:callback});return this;};CancellablePromise.prototype.thenCatch=function(onRejected,opt_context){return this.addChildPromise_(null,onRejected,opt_context);};CancellablePromise.prototype.catch=CancellablePromise.prototype.thenCatch;CancellablePromise.prototype.cancel=function(opt_message){if(this.state_===CancellablePromise.State_.PENDING){async$2.run(function(){var err=new CancellablePromise.CancellationError(opt_message);err.IS_CANCELLATION_ERROR=true;this.cancelInternal_(err);},this);}};CancellablePromise.prototype.cancelInternal_=function(err){if(this.state_===CancellablePromise.State_.PENDING){if(this.parent_){this.parent_.cancelChild_(this,err);}else{this.resolve_(CancellablePromise.State_.REJECTED,err);}}};CancellablePromise.prototype.cancelChild_=function(childPromise,err){if(!this.callbackEntries_){return;}
var childCount=0;var childIndex=-1;for(var i=0,entry;entry=this.callbackEntries_[i];i++){var child=entry.child;if(child){childCount++;if(child===childPromise){childIndex=i;}
if(childIndex>=0&&childCount>1){break;}}}
if(childIndex>=0){if(this.state_===CancellablePromise.State_.PENDING&&childCount===1){this.cancelInternal_(err);}else{var callbackEntry=this.callbackEntries_.splice(childIndex,1)[0];this.executeCallback_(callbackEntry,CancellablePromise.State_.REJECTED,err);}}};CancellablePromise.prototype.addCallbackEntry_=function(callbackEntry){if((!this.callbackEntries_||!this.callbackEntries_.length)&&(this.state_===CancellablePromise.State_.FULFILLED||this.state_===CancellablePromise.State_.REJECTED)){this.scheduleCallbacks_();}
if(!this.callbackEntries_){this.callbackEntries_=[];}
this.callbackEntries_.push(callbackEntry);};CancellablePromise.prototype.addChildPromise_=function(onFulfilled,onRejected,opt_context){var callbackEntry={child:null,onFulfilled:null,onRejected:null};callbackEntry.child=new CancellablePromise(function(resolve,reject){callbackEntry.onFulfilled=onFulfilled?function(value){try{var result=onFulfilled.call(opt_context,value);resolve(result);}catch(err){reject(err);}}:resolve;callbackEntry.onRejected=onRejected?function(reason){try{var result=onRejected.call(opt_context,reason);if(!isDef$1(result)&&reason.IS_CANCELLATION_ERROR){reject(reason);}else{resolve(result);}}catch(err){reject(err);}}:reject;});callbackEntry.child.parent_=this;this.addCallbackEntry_(callbackEntry);return callbackEntry.child;};CancellablePromise.prototype.unblockAndFulfill_=function(value){if(this.state_!==CancellablePromise.State_.BLOCKED){throw new Error('CancellablePromise is not blocked.');}
this.state_=CancellablePromise.State_.PENDING;this.resolve_(CancellablePromise.State_.FULFILLED,value);};CancellablePromise.prototype.unblockAndReject_=function(reason){if(this.state_!==CancellablePromise.State_.BLOCKED){throw new Error('CancellablePromise is not blocked.');}
this.state_=CancellablePromise.State_.PENDING;this.resolve_(CancellablePromise.State_.REJECTED,reason);};CancellablePromise.prototype.resolve_=function(state,x){if(this.state_!==CancellablePromise.State_.PENDING){return;}
if(this===x){state=CancellablePromise.State_.REJECTED;x=new TypeError('CancellablePromise cannot resolve to itself');}else if(Thenable.isImplementedBy(x)){x=x;this.state_=CancellablePromise.State_.BLOCKED;x.then(this.unblockAndFulfill_,this.unblockAndReject_,this);return;}else if(isObject$1(x)){try{var then=x.then;if(isFunction$1(then)){this.tryThen_(x,then);return;}}catch(e){state=CancellablePromise.State_.REJECTED;x=e;}}
this.result_=x;this.state_=state;this.scheduleCallbacks_();if(state===CancellablePromise.State_.REJECTED&&!x.IS_CANCELLATION_ERROR){CancellablePromise.addUnhandledRejection_(this,x);}};CancellablePromise.prototype.tryThen_=function(thenable,then){this.state_=CancellablePromise.State_.BLOCKED;var promise=this;var called=false;var resolve=function resolve(value){if(!called){called=true;promise.unblockAndFulfill_(value);}};var reject=function reject(reason){if(!called){called=true;promise.unblockAndReject_(reason);}};try{then.call(thenable,resolve,reject);}catch(e){reject(e);}};CancellablePromise.prototype.scheduleCallbacks_=function(){if(!this.executing_){this.executing_=true;async$2.run(this.executeCallbacks_,this);}};CancellablePromise.prototype.executeCallbacks_=function(){while(this.callbackEntries_&&this.callbackEntries_.length){var entries=this.callbackEntries_;this.callbackEntries_=[];for(var i=0;i<entries.length;i++){this.executeCallback_(entries[i],this.state_,this.result_);}}
this.executing_=false;};CancellablePromise.prototype.executeCallback_=function(callbackEntry,state,result){if(state===CancellablePromise.State_.FULFILLED){callbackEntry.onFulfilled(result);}else{this.removeUnhandledRejection_();callbackEntry.onRejected(result);}};CancellablePromise.prototype.removeUnhandledRejection_=function(){var p;if(CancellablePromise.UNHANDLED_REJECTION_DELAY>0){for(p=this;p&&p.unhandledRejectionId_;p=p.parent_){clearTimeout(p.unhandledRejectionId_);p.unhandledRejectionId_=0;}}else if(CancellablePromise.UNHANDLED_REJECTION_DELAY===0){for(p=this;p&&p.hadUnhandledRejection_;p=p.parent_){p.hadUnhandledRejection_=false;}}};CancellablePromise.addUnhandledRejection_=function(promise,reason){if(CancellablePromise.UNHANDLED_REJECTION_DELAY>0){promise.unhandledRejectionId_=setTimeout(function(){CancellablePromise.handleRejection_.call(null,reason);},CancellablePromise.UNHANDLED_REJECTION_DELAY);}else if(CancellablePromise.UNHANDLED_REJECTION_DELAY===0){promise.hadUnhandledRejection_=true;async$2.run(function(){if(promise.hadUnhandledRejection_){CancellablePromise.handleRejection_.call(null,reason);}});}};CancellablePromise.handleRejection_=async$2.throwException;CancellablePromise.setUnhandledRejectionHandler=function(handler){CancellablePromise.handleRejection_=handler;};CancellablePromise.CancellationError=function(_Error){inherits(_class,_Error);function _class(opt_message){classCallCheck(this,_class);var _this=possibleConstructorReturn(this,(_class.__proto__||Object.getPrototypeOf(_class)).call(this,opt_message));if(opt_message){_this.message=opt_message;}
return _this;}
return _class;}(Error);CancellablePromise.CancellationError.prototype.name='cancel';function debounce(fn,delay){return function debounced(){var args=arguments;cancelDebounce(debounced);debounced.id=setTimeout(function(){fn.apply(null,args);},delay);};}
function cancelDebounce(debounced){clearTimeout(debounced.id);}
var REGEX=/([\/])?(?:(?:\:(\w+)(?:\(((?:\\.|[^\\()])*)\))?|\(((?:\\.|[^\\()])+)\))([+*?])?)/g;function convertMatchesToObj(matches){return{match:matches[0],prefix:matches[1],name:matches[2],paramPattern:matches[3],unnamedPattern:matches[4],modifier:matches[5]};}
function convertTokensToRegex(tokens){var regex='';for(var i=0;i<tokens.length;i++){if(core$4.isString(tokens[i])){regex+=escape(tokens[i]);}else{var capture=encloseNonCapturingGroup(tokens[i].pattern);if(tokens[i].repeat){capture+=encloseNonCapturingGroup('\\/'+capture)+'*';}
capture=escape(tokens[i].prefix)+('('+capture+')');if(tokens[i].optional){if(!tokens[i].partial){capture=encloseNonCapturingGroup(capture);}
capture+='?';}
regex+=capture;}}
return new RegExp('^'+makeTrailingSlashOptional(regex)+'$');}
function encloseNonCapturingGroup(pattern){return'(?:'+pattern+')';}
function escape(str){return str.replace(/([.+*?=^!:()[\]|\/\\])/g,'\\$1');}
function makeTrailingSlashOptional(regex){if(/\/$/.test(regex)){regex+='?';}else{regex+='\\/?';}
return regex;}
function parse$2(routeOrTokens){if(!core$4.isString(routeOrTokens)){return routeOrTokens;}
var route=routeOrTokens;var unnamedCount=0;var tokens=[];var currPath='';var index=0;var matches=REGEX.exec(route);while(matches){var data=convertMatchesToObj(matches);currPath=route.slice(index,matches.index);index=matches.index+data.match.length;tokens.push(currPath);tokens.push({name:data.name?data.name:''+unnamedCount++,partial:route[index]&&route[index]!==data.prefix,prefix:data.prefix||'',pattern:data.paramPattern||data.unnamedPattern||'[^\\/]+',repeat:data.modifier==='*'||data.modifier==='+',optional:data.modifier==='*'||data.modifier==='?'});matches=REGEX.exec(route);}
if(index<route.length){tokens.push(route.substr(index));}
return tokens;}
function toRegex(routeOrTokens){return convertTokensToRegex(parse$2(routeOrTokens));}
function extractData(routeOrTokens,path){var data={};var tokens=parse$2(routeOrTokens);var match=path.match(convertTokensToRegex(tokens));if(!match){return null;}
var paramIndex=1;for(var i=0;i<tokens.length;i++){if(!core$4.isString(tokens[i])){var value=match[paramIndex++];if(core$4.isDef(value)){if(tokens[i].repeat){value=value.split('/');}
data[tokens[i].name]=value;}}}
return data;}
var Route=function(){function Route(path,handler){classCallCheck(this,Route);if(!isDefAndNotNull$1(path)){throw new Error('Route path not specified.');}
if(!isFunction$1(handler)){throw new Error('Route handler is not a function.');}
this.handler=handler;this.path=path;}
createClass(Route,[{key:'buildParsedData_',value:function buildParsedData_(){if(!this.parsedData_){var tokens=parse$2(this.path);var regex=toRegex(tokens);this.parsedData_={regex:regex,tokens:tokens};}
return this.parsedData_;}},{key:'extractParams',value:function extractParams(path){if(isString$1(this.path)){return extractData(this.buildParsedData_().tokens,path);}
return{};}},{key:'getHandler',value:function getHandler(){return this.handler;}},{key:'getPath',value:function getPath(){return this.path;}},{key:'matchesPath',value:function matchesPath(value){var path=this.path;if(isFunction$1(path)){return path(value);}
if(isString$1(path)){path=this.buildParsedData_().regex;}
if(path instanceof RegExp){return value.search(path)>-1;}
return false;}}]);return Route;}();var Cacheable=function(_Disposable){inherits(Cacheable,_Disposable);function Cacheable(){classCallCheck(this,Cacheable);var _this=possibleConstructorReturn(this,(Cacheable.__proto__||Object.getPrototypeOf(Cacheable)).call(this));_this.cache=null;_this.cacheable=false;return _this;}
createClass(Cacheable,[{key:'addCache',value:function addCache(content){if(this.cacheable){this.cache=content;}
return this;}},{key:'clearCache',value:function clearCache(){this.cache=null;return this;}},{key:'disposeInternal',value:function disposeInternal(){this.clearCache();}},{key:'getCache',value:function getCache(){return this.cache;}},{key:'isCacheable',value:function isCacheable(){return this.cacheable;}},{key:'setCacheable',value:function setCacheable(cacheable){if(!cacheable){this.clearCache();}
this.cacheable=cacheable;}}]);return Cacheable;}(Disposable$2);var Screen=function(_Cacheable){inherits(Screen,_Cacheable);function Screen(){classCallCheck(this,Screen);var _this=possibleConstructorReturn(this,(Screen.__proto__||Object.getPrototypeOf(Screen)).call(this));_this.id=_this.makeId_(getUid$1());_this.metas=null;_this.title=null;return _this;}
createClass(Screen,[{key:'activate',value:function activate(){console.log('Screen ['+this+'] activate');}},{key:'beforeActivate',value:function beforeActivate(){console.log('Screen ['+this+'] beforeActivate');}},{key:'beforeDeactivate',value:function beforeDeactivate(){console.log('Screen ['+this+'] beforeDeactivate');}},{key:'beforeUpdateHistoryPath',value:function beforeUpdateHistoryPath(path){return path;}},{key:'beforeUpdateHistoryState',value:function beforeUpdateHistoryState(state){return state;}},{key:'deactivate',value:function deactivate(){console.log('Screen ['+this+'] deactivate');}},{key:'disposeInternal',value:function disposeInternal(){get(Screen.prototype.__proto__||Object.getPrototypeOf(Screen.prototype),'disposeInternal',this).call(this);console.log('Screen ['+this+'] dispose');}},{key:'evaluateScripts',value:function evaluateScripts(surfaces){Object.keys(surfaces).forEach(function(sId){if(surfaces[sId].activeChild){globalEval.runScriptsInElement(surfaces[sId].activeChild);}});return CancellablePromise.resolve();}},{key:'evaluateStyles',value:function evaluateStyles(){return CancellablePromise.resolve();}},{key:'flip',value:function flip(surfaces){var _this2=this;console.log('Screen ['+this+'] flip');var transitions=[];Object.keys(surfaces).forEach(function(sId){var surface=surfaces[sId];var deferred=surface.show(_this2.id);transitions.push(deferred);});return CancellablePromise.all(transitions);}},{key:'getId',value:function getId(){return this.id;}},{key:'getMetas',value:function getMetas(){return this.metas;}},{key:'getSurfaceContent',value:function getSurfaceContent(){console.log('Screen ['+this+'] getSurfaceContent');}},{key:'getTitle',value:function getTitle(){return this.title;}},{key:'load',value:function load(){console.log('Screen ['+this+'] load');return CancellablePromise.resolve();}},{key:'makeId_',value:function makeId_(id){return'screen_'+id;}},{key:'setId',value:function setId(id){this.id=id;}},{key:'setMetas',value:function setMetas(metas){this.metas=metas;}},{key:'setTitle',value:function setTitle(title){this.title=title;}},{key:'toString',value:function toString(){return this.id;}}]);return Screen;}(Cacheable);Screen.isImplementedBy=function(object){return object instanceof Screen;};var Surface=function(_Disposable){inherits(Surface,_Disposable);function Surface(id){classCallCheck(this,Surface);var _this=possibleConstructorReturn(this,(Surface.__proto__||Object.getPrototypeOf(Surface)).call(this));if(!id){throw new Error('Surface element id not specified. A surface element requires a valid id.');}
_this.activeChild=null;_this.defaultChild=null;_this.element=null;_this.id=id;_this.transitionFn=null;_this.defaultChild=_this.getChild(Surface.DEFAULT);_this.maybeWrapContentAsDefault_();_this.activeChild=_this.defaultChild;return _this;}
createClass(Surface,[{key:'addContent',value:function addContent(screenId,opt_content){var child=this.defaultChild;if(isDefAndNotNull$1(opt_content)){child=this.getChild(screenId);if(child){removeChildren(child);}else{child=this.createChild(screenId);this.transition(child,null);}
append(child,opt_content);}
var element=this.getElement();if(element&&child){append(element,child);}
return child;}},{key:'createChild',value:function createChild(screenId){var child=globals.document.createElement('div');child.setAttribute('id',this.makeId_(screenId));return child;}},{key:'getChild',value:function getChild(screenId){return globals.document.getElementById(this.makeId_(screenId));}},{key:'getElement',value:function getElement(){if(this.element){return this.element;}
this.element=globals.document.getElementById(this.id);return this.element;}},{key:'getId',value:function getId(){return this.id;}},{key:'getTransitionFn',value:function getTransitionFn(){return this.transitionFn;}},{key:'makeId_',value:function makeId_(screenId){return this.id+'-'+screenId;}},{key:'maybeWrapContentAsDefault_',value:function maybeWrapContentAsDefault_(){var element=this.getElement();if(element&&!this.defaultChild){var fragment=globals.document.createDocumentFragment();while(element.firstChild){fragment.appendChild(element.firstChild);}
this.defaultChild=this.addContent(Surface.DEFAULT,fragment);this.transition(null,this.defaultChild);}}},{key:'setId',value:function setId(id){this.id=id;}},{key:'setTransitionFn',value:function setTransitionFn(transitionFn){this.transitionFn=transitionFn;}},{key:'show',value:function show(screenId){var from=this.activeChild;var to=this.getChild(screenId);if(!to){to=this.defaultChild;}
this.activeChild=to;return this.transition(from,to).thenAlways(function(){if(from&&from!==to){exitDocument(from);}});}},{key:'remove',value:function remove(screenId){var child=this.getChild(screenId);if(child){exitDocument(child);}}},{key:'toString',value:function toString(){return this.id;}},{key:'transition',value:function transition(from,to){var transitionFn=this.transitionFn||Surface.defaultTransition;return CancellablePromise.resolve(transitionFn.call(this,from,to));}}]);return Surface;}(Disposable$2);Surface.DEFAULT='default';Surface.defaultTransition=function(from,to){if(from){from.style.display='none';from.classList.remove('flipped');}
if(to){to.style.display='block';to.classList.add('flipped');}};var NavigationStrategy={IMMEDIATE:'immediate',SCHEDULE_LAST:'scheduleLast'};var App$1=function(_EventEmitter){inherits(App,_EventEmitter);function App(){classCallCheck(this,App);var _this=possibleConstructorReturn(this,(App.__proto__||Object.getPrototypeOf(App)).call(this));_this.activeScreen=null;_this.activePath=null;_this.allowPreventNavigate=true;_this.basePath='';_this.browserPathBeforeNavigate=utils.getCurrentBrowserPathWithoutHash();_this.captureScrollPositionFromScrollEvent=true;_this.defaultTitle=globals.document.title;_this.formSelector='form[enctype="multipart/form-data"]:not([data-senna-off])';_this.ignoreQueryStringFromRoutePath=false;_this.linkSelector='a:not([data-senna-off]):not([target="_blank"])';_this.loadingCssClass='senna-loading';_this.nativeScrollRestorationSupported='scrollRestoration'in globals.window.history;_this.navigationStrategy=NavigationStrategy.IMMEDIATE;_this.isNavigationPending=false;_this.pendingNavigate=null;_this.popstateScrollLeft=0;_this.popstateScrollTop=0;_this.redirectPath=null;_this.routes=[];_this.scheduledNavigationQueue=[];_this.screens={};_this.skipLoadPopstate=false;_this.surfaces={};_this.updateScrollPosition=true;_this.appEventHandlers_=new EventHandler$2();_this.appEventHandlers_.add(on(globals.window,'scroll',debounce(_this.onScroll_.bind(_this),100)),on(globals.window,'load',_this.onLoad_.bind(_this)),on(globals.window,'popstate',_this.onPopstate_.bind(_this)));_this.on('startNavigate',_this.onStartNavigate_);_this.on('beforeNavigate',_this.onBeforeNavigate_);_this.on('beforeNavigate',_this.onBeforeNavigateDefault_,true);_this.on('beforeUnload',_this.onBeforeUnloadDefault_);_this.setLinkSelector(_this.linkSelector);_this.setFormSelector(_this.formSelector);_this.maybeOverloadBeforeUnload_();return _this;}
createClass(App,[{key:'addRoutes',value:function addRoutes(routes){var _this2=this;if(!Array.isArray(routes)){routes=[routes];}
routes.forEach(function(route){if(!(route instanceof Route)){route=new Route(route.path,route.handler);}
_this2.routes.push(route);});return this;}},{key:'addSurfaces',value:function addSurfaces(surfaces){var _this3=this;if(!Array.isArray(surfaces)){surfaces=[surfaces];}
surfaces.forEach(function(surface){if(isString$1(surface)){surface=new Surface(surface);}
_this3.surfaces[surface.getId()]=surface;});return this;}},{key:'canNavigate',value:function canNavigate(url){var uri=utils.isWebUri(url);if(!uri){return false;}
var path=utils.getUrlPath(url);if(!this.isLinkSameOrigin_(uri.getHost())){console.log('Offsite link clicked');return false;}
if(!this.isSameBasePath_(path)){console.log('Link clicked outside app\'s base path');return false;}
if(uri.getHash()&&utils.isCurrentBrowserPath(path)){return false;}
if(!this.findRoute(path)){console.log('No route for '+path);return false;}
return true;}},{key:'clearScreensCache',value:function clearScreensCache(){var _this4=this;Object.keys(this.screens).forEach(function(path){if(path===_this4.activePath){_this4.activeScreen.clearCache();}else if(!(_this4.isNavigationPending&&_this4.pendingNavigate.path===path)){_this4.removeScreen(path);}});}},{key:'createScreenInstance',value:function createScreenInstance(path,route){if(!this.pendingNavigate&&path===this.activePath){console.log('Already at destination, refresh navigation');return this.activeScreen;}
var screen=this.screens[path];if(!screen){var handler=route.getHandler();if(handler===Screen||Screen.isImplementedBy(handler.prototype)){screen=new handler();}else{screen=handler(route)||new Screen();}
console.log('Create screen for ['+path+'] ['+screen+']');}
return screen;}},{key:'disposeInternal',value:function disposeInternal(){if(this.activeScreen){this.removeScreen(this.activePath);}
this.clearScreensCache();this.formEventHandler_.removeListener();this.linkEventHandler_.removeListener();this.appEventHandlers_.removeAllListeners();get(App.prototype.__proto__||Object.getPrototypeOf(App.prototype),'disposeInternal',this).call(this);}},{key:'dispatch',value:function dispatch(){return this.navigate(utils.getCurrentBrowserPath(),true);}},{key:'doNavigate_',value:function doNavigate_(path,opt_replaceHistory){var _this5=this;var route=this.findRoute(path);if(!route){this.pendingNavigate=CancellablePromise.reject(new CancellablePromise.CancellationError('No route for '+path));return this.pendingNavigate;}
console.log('Navigate to ['+path+']');this.stopPendingNavigate_();this.isNavigationPending=true;var nextScreen=this.createScreenInstance(path,route);return this.maybePreventDeactivate_().then(function(){return _this5.maybePreventActivate_(nextScreen);}).then(function(){return nextScreen.load(path);}).then(function(){_this5.navigationStrategy=NavigationStrategy.SCHEDULE_LAST;if(_this5.activeScreen){_this5.activeScreen.deactivate();}
_this5.prepareNavigateHistory_(path,nextScreen,opt_replaceHistory);_this5.prepareNavigateSurfaces_(nextScreen,_this5.surfaces,_this5.extractParams(route,path));}).then(function(){return nextScreen.evaluateStyles(_this5.surfaces);}).then(function(){return nextScreen.flip(_this5.surfaces);}).then(function(){return nextScreen.evaluateScripts(_this5.surfaces);}).then(function(){return _this5.maybeUpdateScrollPositionState_();}).then(function(){return _this5.syncScrollPositionSyncThenAsync_();}).then(function(){return _this5.finalizeNavigate_(path,nextScreen);}).then(function(){return _this5.maybeOverloadBeforeUnload_();}).catch(function(reason){_this5.isNavigationPending=false;_this5.handleNavigateError_(path,nextScreen,reason);throw reason;}).thenAlways(function(){_this5.navigationStrategy=NavigationStrategy.IMMEDIATE;if(_this5.scheduledNavigationQueue.length){var scheduledNavigation=_this5.scheduledNavigationQueue.shift();_this5.maybeNavigate_(scheduledNavigation.href,scheduledNavigation);}});}},{key:'extractParams',value:function extractParams(route,path){return route.extractParams(this.getRoutePath(path));}},{key:'finalizeNavigate_',value:function finalizeNavigate_(path,nextScreen){nextScreen.activate();if(this.activeScreen&&!this.activeScreen.isCacheable()){if(this.activeScreen!==nextScreen){this.removeScreen(this.activePath);}}
this.activePath=path;this.activeScreen=nextScreen;this.browserPathBeforeNavigate=utils.getCurrentBrowserPathWithoutHash();this.screens[path]=nextScreen;this.isNavigationPending=false;this.pendingNavigate=null;globals.capturedFormElement=null;globals.capturedFormButtonElement=null;console.log('Navigation done');}},{key:'findRoute',value:function findRoute(path){path=this.getRoutePath(path);for(var i=0;i<this.routes.length;i++){var route=this.routes[i];if(route.matchesPath(path)){return route;}}
return null;}},{key:'getAllowPreventNavigate',value:function getAllowPreventNavigate(){return this.allowPreventNavigate;}},{key:'getBasePath',value:function getBasePath(){return this.basePath;}},{key:'getDefaultTitle',value:function getDefaultTitle(){return this.defaultTitle;}},{key:'getFormSelector',value:function getFormSelector(){return this.formSelector;}},{key:'getIgnoreQueryStringFromRoutePath',value:function getIgnoreQueryStringFromRoutePath(){return this.ignoreQueryStringFromRoutePath;}},{key:'getLinkSelector',value:function getLinkSelector(){return this.linkSelector;}},{key:'getLoadingCssClass',value:function getLoadingCssClass(){return this.loadingCssClass;}},{key:'getRoutePath',value:function getRoutePath(path){if(this.getIgnoreQueryStringFromRoutePath()){path=utils.getUrlPathWithoutHashAndSearch(path);return utils.getUrlPathWithoutHashAndSearch(path.substr(this.basePath.length));}
path=utils.getUrlPathWithoutHash(path);return utils.getUrlPathWithoutHash(path.substr(this.basePath.length));}},{key:'getUpdateScrollPosition',value:function getUpdateScrollPosition(){return this.updateScrollPosition;}},{key:'handleNavigateError_',value:function handleNavigateError_(path,nextScreen,error){var _this6=this;console.log('Navigation error for ['+nextScreen+'] ('+error.stack+')');this.emit('navigationError',{error:error,nextScreen:nextScreen,path:path});if(!utils.isCurrentBrowserPath(path)){if(this.isNavigationPending&&this.pendingNavigate){this.pendingNavigate.thenAlways(function(){return _this6.removeScreen(path);},this);}else{this.removeScreen(path);}}}},{key:'hasRoutes',value:function hasRoutes(){return this.routes.length>0;}},{key:'isLinkSameOrigin_',value:function isLinkSameOrigin_(host){var hostUri=new Uri(host);var locationHostUri=new Uri(globals.window.location.host);return hostUri.getPort()===locationHostUri.getPort()&&hostUri.getHostname()===locationHostUri.getHostname();}},{key:'isSameBasePath_',value:function isSameBasePath_(path){return path.indexOf(this.basePath)===0;}},{key:'lockHistoryScrollPosition_',value:function lockHistoryScrollPosition_(){var state=globals.window.history.state;if(!state){return;}
var winner=false;var switchScrollPositionRace=function switchScrollPositionRace(){globals.document.removeEventListener('scroll',switchScrollPositionRace,false);if(!winner){globals.window.scrollTo(state.scrollLeft,state.scrollTop);winner=true;}};async$2.nextTick(switchScrollPositionRace);globals.document.addEventListener('scroll',switchScrollPositionRace,false);}},{key:'maybeDisableNativeScrollRestoration',value:function maybeDisableNativeScrollRestoration(){if(this.nativeScrollRestorationSupported){this.nativeScrollRestoration_=globals.window.history.scrollRestoration;globals.window.history.scrollRestoration='manual';}}},{key:'maybeScheduleNavigation_',value:function maybeScheduleNavigation_(href,event){if(this.isNavigationPending&&this.navigationStrategy===NavigationStrategy.SCHEDULE_LAST){this.scheduledNavigationQueue=[object$2.mixin({href:href,isScheduledNavigation:true},event)];return true;}
return false;}},{key:'maybeNavigate_',value:function maybeNavigate_(href,event){if(!this.canNavigate(href)){return;}
var isNavigationScheduled=this.maybeScheduleNavigation_(href,event);if(isNavigationScheduled){event.preventDefault();return;}
var navigateFailed=false;try{this.navigate(utils.getUrlPath(href),false,event);}catch(err){navigateFailed=true;}
if(!navigateFailed&&!event.isScheduledNavigation){event.preventDefault();}}},{key:'maybeOverloadBeforeUnload_',value:function maybeOverloadBeforeUnload_(){var _this7=this;if('function'===typeof window.onbeforeunload){window._onbeforeunload=window.onbeforeunload;window.onbeforeunload=function(event){_this7.emit('beforeUnload',event);if(event&&event.defaultPrevented){return true;}};window.onbeforeunload._overloaded=true;}}},{key:'maybePreventActivate_',value:function maybePreventActivate_(nextScreen){var _this8=this;return CancellablePromise.resolve().then(function(){return nextScreen.beforeActivate();}).then(function(prevent){if(prevent){_this8.pendingNavigate=CancellablePromise.reject(new CancellablePromise.CancellationError('Cancelled by next screen'));return _this8.pendingNavigate;}});}},{key:'maybePreventDeactivate_',value:function maybePreventDeactivate_(){var _this9=this;return CancellablePromise.resolve().then(function(){if(_this9.activeScreen){return _this9.activeScreen.beforeDeactivate();}}).then(function(prevent){if(prevent){_this9.pendingNavigate=CancellablePromise.reject(new CancellablePromise.CancellationError('Cancelled by active screen'));return _this9.pendingNavigate;}});}},{key:'maybeRepositionScrollToHashedAnchor',value:function maybeRepositionScrollToHashedAnchor(){var hash=globals.window.location.hash;if(hash){var anchorElement=globals.document.getElementById(hash.substring(1));if(anchorElement){var _utils$getNodeOffset=utils.getNodeOffset(anchorElement),offsetLeft=_utils$getNodeOffset.offsetLeft,offsetTop=_utils$getNodeOffset.offsetTop;globals.window.scrollTo(offsetLeft,offsetTop);}}}},{key:'maybeRestoreNativeScrollRestoration',value:function maybeRestoreNativeScrollRestoration(){if(this.nativeScrollRestorationSupported&&this.nativeScrollRestoration_){globals.window.history.scrollRestoration=this.nativeScrollRestoration_;}}},{key:'maybeRestoreRedirectPathHash_',value:function maybeRestoreRedirectPathHash_(path,redirectPath,hash){if(redirectPath===utils.getUrlPathWithoutHash(path)){return redirectPath+hash;}
return redirectPath;}},{key:'maybeUpdateScrollPositionState_',value:function maybeUpdateScrollPositionState_(){var hash=globals.window.location.hash;var anchorElement=globals.document.getElementById(hash.substring(1));if(anchorElement){var _utils$getNodeOffset2=utils.getNodeOffset(anchorElement),offsetLeft=_utils$getNodeOffset2.offsetLeft,offsetTop=_utils$getNodeOffset2.offsetTop;this.saveHistoryCurrentPageScrollPosition_(offsetTop,offsetLeft);}}},{key:'navigate',value:function navigate(path,opt_replaceHistory,opt_event){if(!utils.isHtml5HistorySupported()){throw new Error('HTML5 History is not supported. Senna will not intercept navigation.');}
if(opt_event){globals.capturedFormElement=opt_event.capturedFormElement;globals.capturedFormButtonElement=opt_event.capturedFormButtonElement;}
if(path===this.activePath){opt_replaceHistory=true;}
this.emit('beforeNavigate',{event:opt_event,path:path,replaceHistory:!!opt_replaceHistory});return this.pendingNavigate;}},{key:'onBeforeNavigate_',value:function onBeforeNavigate_(event){if(globals.capturedFormElement){event.form=globals.capturedFormElement;}}},{key:'onBeforeNavigateDefault_',value:function onBeforeNavigateDefault_(event){if(this.pendingNavigate){if(this.pendingNavigate.path===event.path||this.navigationStrategy===NavigationStrategy.SCHEDULE_LAST){console.log('Waiting...');return;}}
this.emit('beforeUnload',event);this.emit('startNavigate',{form:event.form,path:event.path,replaceHistory:event.replaceHistory});}},{key:'onBeforeUnloadDefault_',value:function onBeforeUnloadDefault_(event){var func=window._onbeforeunload;if(func&&!func._overloaded&&func()){event.preventDefault();}}},{key:'onDocClickDelegate_',value:function onDocClickDelegate_(event){if(event.altKey||event.ctrlKey||event.metaKey||event.shiftKey||event.button){console.log('Navigate aborted, invalid mouse button or modifier key pressed.');return;}
this.maybeNavigate_(event.delegateTarget.href,event);}},{key:'onDocSubmitDelegate_',value:function onDocSubmitDelegate_(event){var form=event.delegateTarget;if(form.method==='get'){console.log('GET method not supported');return;}
event.capturedFormElement=form;var buttonSelector='button:not([type]),button[type=submit],input[type=submit]';if(match(globals.document.activeElement,buttonSelector)){event.capturedFormButtonElement=globals.document.activeElement;}else{event.capturedFormButtonElement=form.querySelector(buttonSelector);}
this.maybeNavigate_(form.action,event);}},{key:'onLoad_',value:function onLoad_(){var _this10=this;this.skipLoadPopstate=true;setTimeout(function(){_this10.skipLoadPopstate=false;},0);this.maybeRepositionScrollToHashedAnchor();}},{key:'onPopstate_',value:function onPopstate_(event){if(this.skipLoadPopstate){return;}
if(utils.isCurrentBrowserPath(this.browserPathBeforeNavigate)){this.maybeRepositionScrollToHashedAnchor();return;}
var state=event.state;if(!state){if(globals.window.location.hash){if(this.redirectPath&&!utils.isCurrentBrowserPath(this.redirectPath)){this.reloadPage();}
this.maybeRepositionScrollToHashedAnchor();}else{this.reloadPage();}
return;}
if(state.senna){console.log('History navigation to ['+state.path+']');this.popstateScrollTop=state.scrollTop;this.popstateScrollLeft=state.scrollLeft;if(!this.nativeScrollRestorationSupported){this.lockHistoryScrollPosition_();}
this.once('endNavigate',function(){if(state.referrer){utils.setReferrer(state.referrer);}});var uri=new Uri(state.path);uri.setHostname(globals.window.location.hostname);uri.setPort(globals.window.location.port);var isNavigationScheduled=this.maybeScheduleNavigation_(uri.toString(),{});if(isNavigationScheduled){return;}
this.navigate(state.path,true);}}},{key:'onScroll_',value:function onScroll_(){if(this.captureScrollPositionFromScrollEvent){this.saveHistoryCurrentPageScrollPosition_(globals.window.pageYOffset,globals.window.pageXOffset);}}},{key:'onStartNavigate_',value:function onStartNavigate_(event){var _this11=this;this.maybeDisableNativeScrollRestoration();this.captureScrollPositionFromScrollEvent=false;addClasses(globals.document.documentElement,this.loadingCssClass);var endNavigatePayload={form:event.form,path:event.path};this.pendingNavigate=this.doNavigate_(event.path,event.replaceHistory).catch(function(reason){endNavigatePayload.error=reason;throw reason;}).thenAlways(function(){if(!_this11.pendingNavigate&&!_this11.scheduledNavigationQueue.length){removeClasses(globals.document.documentElement,_this11.loadingCssClass);_this11.maybeRestoreNativeScrollRestoration();_this11.captureScrollPositionFromScrollEvent=true;}
_this11.emit('endNavigate',endNavigatePayload);});this.pendingNavigate.path=event.path;}},{key:'prefetch',value:function prefetch(path){var _this12=this;var route=this.findRoute(path);if(!route){return CancellablePromise.reject(new CancellablePromise.CancellationError('No route for '+path));}
console.log('Prefetching ['+path+']');var nextScreen=this.createScreenInstance(path,route);return nextScreen.load(path).then(function(){return _this12.screens[path]=nextScreen;}).catch(function(reason){_this12.handleNavigateError_(path,nextScreen,reason);throw reason;});}},{key:'prepareNavigateHistory_',value:function prepareNavigateHistory_(path,nextScreen,opt_replaceHistory){var title=nextScreen.getTitle();if(!isString$1(title)){title=this.getDefaultTitle();}
var redirectPath=nextScreen.beforeUpdateHistoryPath(path);var historyState={form:isDefAndNotNull$1(globals.capturedFormElement),path:path,redirectPath:redirectPath,scrollLeft:0,scrollTop:0,senna:true};if(opt_replaceHistory){historyState.scrollTop=this.popstateScrollTop;historyState.scrollLeft=this.popstateScrollLeft;}
var hash=new Uri(path).getHash();redirectPath=this.maybeRestoreRedirectPathHash_(path,redirectPath,hash);this.updateHistory_(title,redirectPath,nextScreen.beforeUpdateHistoryState(historyState),opt_replaceHistory);this.redirectPath=redirectPath;}},{key:'prepareNavigateSurfaces_',value:function prepareNavigateSurfaces_(nextScreen,surfaces,params){Object.keys(surfaces).forEach(function(id){var surfaceContent=nextScreen.getSurfaceContent(id,params);surfaces[id].addContent(nextScreen.getId(),surfaceContent);console.log('Screen ['+nextScreen.getId()+'] add content to surface '+'['+surfaces[id]+'] ['+(isDefAndNotNull$1(surfaceContent)?'...':'empty')+']');});}},{key:'reloadPage',value:function reloadPage(){globals.window.location.reload();}},{key:'removeRoute',value:function removeRoute(route){return array$2.remove(this.routes,route);}},{key:'removeScreen',value:function removeScreen(path){var _this13=this;var screen=this.screens[path];if(screen){Object.keys(this.surfaces).forEach(function(surfaceId){return _this13.surfaces[surfaceId].remove(screen.getId());});screen.dispose();delete this.screens[path];}}},{key:'saveHistoryCurrentPageScrollPosition_',value:function saveHistoryCurrentPageScrollPosition_(scrollTop,scrollLeft){var state=globals.window.history.state;if(state&&state.senna){var _ref=[scrollTop,scrollLeft];state.scrollTop=_ref[0];state.scrollLeft=_ref[1];globals.window.history.replaceState(state,null,null);}}},{key:'setAllowPreventNavigate',value:function setAllowPreventNavigate(allowPreventNavigate){this.allowPreventNavigate=allowPreventNavigate;}},{key:'setBasePath',value:function setBasePath(basePath){this.basePath=utils.removePathTrailingSlash(basePath);}},{key:'setDefaultTitle',value:function setDefaultTitle(defaultTitle){this.defaultTitle=defaultTitle;}},{key:'setFormSelector',value:function setFormSelector(formSelector){this.formSelector=formSelector;if(this.formEventHandler_){this.formEventHandler_.removeListener();}
this.formEventHandler_=delegate(document,'submit',this.formSelector,this.onDocSubmitDelegate_.bind(this),this.allowPreventNavigate);}},{key:'setIgnoreQueryStringFromRoutePath',value:function setIgnoreQueryStringFromRoutePath(ignoreQueryStringFromRoutePath){this.ignoreQueryStringFromRoutePath=ignoreQueryStringFromRoutePath;}},{key:'setLinkSelector',value:function setLinkSelector(linkSelector){this.linkSelector=linkSelector;if(this.linkEventHandler_){this.linkEventHandler_.removeListener();}
this.linkEventHandler_=delegate(document,'click',this.linkSelector,this.onDocClickDelegate_.bind(this),this.allowPreventNavigate);}},{key:'setLoadingCssClass',value:function setLoadingCssClass(loadingCssClass){this.loadingCssClass=loadingCssClass;}},{key:'setUpdateScrollPosition',value:function setUpdateScrollPosition(updateScrollPosition){this.updateScrollPosition=updateScrollPosition;}},{key:'stopPendingNavigate_',value:function stopPendingNavigate_(){if(this.pendingNavigate){this.pendingNavigate.cancel('Cancel pending navigation');}
this.pendingNavigate=null;}},{key:'syncScrollPositionSyncThenAsync_',value:function syncScrollPositionSyncThenAsync_(){var _this14=this;var state=globals.window.history.state;if(!state){return;}
var scrollTop=state.scrollTop;var scrollLeft=state.scrollLeft;var sync=function sync(){if(_this14.updateScrollPosition){globals.window.scrollTo(scrollLeft,scrollTop);}};return new CancellablePromise(function(resolve){return sync()&async$2.nextTick(function(){return sync()&resolve();});});}},{key:'updateHistory_',value:function updateHistory_(title,path,state,opt_replaceHistory){var referrer=globals.window.location.href;if(state){state.referrer=referrer;}
if(opt_replaceHistory){globals.window.history.replaceState(state,title,path);}else{globals.window.history.pushState(state,title,path);}
utils.setReferrer(referrer);var titleNode=globals.document.querySelector('title');if(titleNode){titleNode.innerHTML=title;}else{globals.document.title=title;}}}]);return App;}(EventEmitter$4);var Ajax=function(){function Ajax(){classCallCheck(this,Ajax);}
createClass(Ajax,null,[{key:'parseResponseHeaders',value:function parseResponseHeaders(allHeaders){var headers=[];if(!allHeaders){return headers;}
var pairs=allHeaders.split('\r\n');for(var i=0;i<pairs.length;i++){var index=pairs[i].indexOf(': ');if(index>0){var name=pairs[i].substring(0,index);var value=pairs[i].substring(index+2);headers.push({name:name,value:value});}}
return headers;}},{key:'request',value:function request(url,method,body,opt_headers,opt_params,opt_timeout,opt_sync,opt_withCredentials){url=url||'';method=method||'GET';var request=new XMLHttpRequest();var previousReadyState=0;var promise=new CancellablePromise(function(resolve,reject){request.onload=function(){if(request.aborted){request.onerror();return;}
resolve(request);};request.onreadystatechange=function(){if(previousReadyState&&previousReadyState<3&&4===request.readyState){request.terminatedPrematurely=true;}
previousReadyState=request.readyState;};request.onerror=function(){var message='Request error';if(request.terminatedPrematurely){message='Request terminated prematurely';}
var error=new Error(message);error.request=request;reject(error);};}).thenCatch(function(reason){request.abort();throw reason;}).thenAlways(function(){clearTimeout(timeout);});url=new Uri(url);if(opt_params){url.addParametersFromMultiMap(opt_params).toString();}
url=url.toString();request.open(method,url,!opt_sync);if(opt_withCredentials){request.withCredentials=true;}
if(opt_headers){opt_headers.names().forEach(function(name){request.setRequestHeader(name,opt_headers.getAll(name).join(', '));});}
request.send(isDef$1(body)?body:null);if(isDefAndNotNull$1(opt_timeout)){var timeout=setTimeout(function(){promise.cancel('Request timeout');},opt_timeout);}
return promise;}}]);return Ajax;}();var errors=function errors(){classCallCheck(this,errors);};errors.INVALID_STATUS='Invalid status code';errors.REQUEST_ERROR='Request error';errors.REQUEST_TIMEOUT='Request timeout';errors.REQUEST_PREMATURE_TERMINATION='Request terminated prematurely';var UA=function(){function UA(){classCallCheck(this,UA);}
createClass(UA,null,[{key:'getNativeUserAgent',value:function getNativeUserAgent(){var navigator=UA.globals.window&&UA.globals.window.navigator;if(navigator){var userAgent=navigator.userAgent;if(userAgent){return userAgent;}}
return'';}},{key:'getNativePlatform',value:function getNativePlatform(){var navigator=UA.globals.window&&UA.globals.window.navigator;if(navigator){var platform=navigator.platform;if(platform){return platform;}}
return'';}},{key:'matchPlatform',value:function matchPlatform(str){return UA.platform.indexOf(str)!==-1;}},{key:'matchUserAgent',value:function matchUserAgent(str){return UA.userAgent.indexOf(str)!==-1;}},{key:'testUserAgent',value:function testUserAgent(){var userAgent=arguments.length>0&&arguments[0]!==undefined?arguments[0]:'';var platform=arguments.length>1&&arguments[1]!==undefined?arguments[1]:'';UA.userAgent=userAgent;UA.platform=platform;UA.isMac=UA.matchPlatform('Mac');UA.isWin=UA.matchPlatform('Win');UA.isOpera=UA.matchUserAgent('Opera')||UA.matchUserAgent('OPR');UA.isIe=UA.matchUserAgent('Trident')||UA.matchUserAgent('MSIE');UA.isEdge=UA.matchUserAgent('Edge');UA.isIeOrEdge=UA.isIe||UA.isEdge;UA.isChrome=(UA.matchUserAgent('Chrome')||UA.matchUserAgent('CriOS'))&&!UA.isOpera&&!UA.isEdge;UA.isSafari=UA.matchUserAgent('Safari')&&!(UA.isChrome||UA.isOpera||UA.isEdge);UA.isFirefox=UA.matchUserAgent('Firefox');}}]);return UA;}();Object.defineProperty(UA,'globals',{writable:true,value:{window:isServerSide$1()?null:window}});UA.testUserAgent(UA.getNativeUserAgent(),UA.getNativePlatform());var RequestScreen=function(_Screen){inherits(RequestScreen,_Screen);function RequestScreen(){classCallCheck(this,RequestScreen);var _this=possibleConstructorReturn(this,(RequestScreen.__proto__||Object.getPrototypeOf(RequestScreen)).call(this));_this.cacheable=true;_this.httpHeaders={'X-PJAX':'true','X-Requested-With':'XMLHttpRequest'};_this.httpMethod=RequestScreen.GET;_this.request=null;_this.timeout=30000;return _this;}
createClass(RequestScreen,[{key:'assertValidResponseStatusCode',value:function assertValidResponseStatusCode(status){if(!this.isValidResponseStatusCode(status)){var error=new Error(errors.INVALID_STATUS);error.invalidStatus=true;error.statusCode=status;throw error;}}},{key:'beforeUpdateHistoryPath',value:function beforeUpdateHistoryPath(path){var redirectPath=this.getRequestPath();if(redirectPath&&redirectPath!==path){return redirectPath;}
return path;}},{key:'beforeUpdateHistoryState',value:function beforeUpdateHistoryState(state){if(state.senna&&state.form&&state.redirectPath===state.path){return null;}
return state;}},{key:'formatLoadPath',value:function formatLoadPath(path){var uri=new Uri(path);uri.setHostname(globals.window.location.hostname);uri.setProtocol(globals.window.location.protocol);if(globals.window.location.port){uri.setPort(globals.window.location.port);}
if(UA.isIeOrEdge&&this.httpMethod===RequestScreen.GET){return uri.makeUnique().toString();}
return uri.toString();}},{key:'getHttpHeaders',value:function getHttpHeaders(){return this.httpHeaders;}},{key:'getHttpMethod',value:function getHttpMethod(){return this.httpMethod;}},{key:'getRequestPath',value:function getRequestPath(){var request=this.getRequest();if(request){var requestPath=request.requestPath;var responseUrl=this.maybeExtractResponseUrlFromRequest(request);if(responseUrl){requestPath=responseUrl;}
if(UA.isIeOrEdge&&this.httpMethod===RequestScreen.GET){requestPath=new Uri(requestPath).removeUnique().toString();}
return utils.getUrlPath(requestPath);}
return null;}},{key:'getRequest',value:function getRequest(){return this.request;}},{key:'getTimeout',value:function getTimeout(){return this.timeout;}},{key:'isValidResponseStatusCode',value:function isValidResponseStatusCode(statusCode){return statusCode>=200&&statusCode<=399;}},{key:'load',value:function load(path){var _this2=this;var cache=this.getCache();if(isDefAndNotNull$1(cache)){return CancellablePromise.resolve(cache);}
var body=null;var httpMethod=this.httpMethod;var headers=new MultiMap();Object.keys(this.httpHeaders).forEach(function(header){return headers.add(header,_this2.httpHeaders[header]);});if(globals.capturedFormElement){this.addSafariXHRPolyfill();body=new FormData(globals.capturedFormElement);this.maybeAppendSubmitButtonValue_(body);httpMethod=RequestScreen.POST;if(UA.isIeOrEdge){headers.add('If-None-Match','"0"');}}
var requestPath=this.formatLoadPath(path);return Ajax.request(requestPath,httpMethod,body,headers,null,this.timeout).then(function(xhr){_this2.removeSafariXHRPolyfill();_this2.setRequest(xhr);_this2.assertValidResponseStatusCode(xhr.status);if(httpMethod===RequestScreen.GET&&_this2.isCacheable()){_this2.addCache(xhr.responseText);}
xhr.requestPath=requestPath;return xhr.responseText;}).catch(function(reason){_this2.removeSafariXHRPolyfill();switch(reason.message){case errors.REQUEST_TIMEOUT:reason.timeout=true;break;case errors.REQUEST_ERROR:reason.requestError=true;break;case errors.REQUEST_PREMATURE_TERMINATION:reason.requestError=true;reason.requestPrematureTermination=true;break;}
throw reason;});}},{key:'maybeAppendSubmitButtonValue_',value:function maybeAppendSubmitButtonValue_(body){var button=globals.capturedFormButtonElement;if(button&&button.name){body.append(button.name,button.value);}}},{key:'maybeExtractResponseUrlFromRequest',value:function maybeExtractResponseUrlFromRequest(request){var responseUrl=request.responseURL;if(responseUrl){return responseUrl;}
return request.getResponseHeader(RequestScreen.X_REQUEST_URL_HEADER);}},{key:'addSafariXHRPolyfill',value:function addSafariXHRPolyfill(){if(globals.capturedFormElement&&UA.isSafari){var inputs=globals.capturedFormElement.querySelectorAll('input[type="file"]:not([disabled])');for(var index=0;index<inputs.length;index++){var input=inputs[index];if(input.files.length>0){return;}
input.setAttribute('data-safari-temp-disabled','true');input.setAttribute('disabled','');}}}},{key:'removeSafariXHRPolyfill',value:function removeSafariXHRPolyfill(){if(globals.capturedFormElement&&UA.isSafari){var inputs=globals.capturedFormElement.querySelectorAll('input[type="file"][data-safari-temp-disabled]');for(var index=0;index<inputs.length;index++){var input=inputs[index];input.removeAttribute('data-safari-temp-disabled');input.removeAttribute('disabled');}}}},{key:'setHttpHeaders',value:function setHttpHeaders(httpHeaders){this.httpHeaders=httpHeaders;}},{key:'setHttpMethod',value:function setHttpMethod(httpMethod){this.httpMethod=httpMethod.toLowerCase();}},{key:'setRequest',value:function setRequest(request){this.request=request;}},{key:'setTimeout',value:function setTimeout(timeout){this.timeout=timeout;}}]);return RequestScreen;}(Screen);RequestScreen.GET='get';RequestScreen.POST='post';RequestScreen.X_REQUEST_URL_HEADER='X-Request-URL';var HtmlScreen=function(_RequestScreen){inherits(HtmlScreen,_RequestScreen);function HtmlScreen(){classCallCheck(this,HtmlScreen);var _this=possibleConstructorReturn(this,(HtmlScreen.__proto__||Object.getPrototypeOf(HtmlScreen)).call(this));_this.metaTagsSelector='meta';_this.titleSelector='title';return _this;}
createClass(HtmlScreen,[{key:'activate',value:function activate(){get(HtmlScreen.prototype.__proto__||Object.getPrototypeOf(HtmlScreen.prototype),'activate',this).call(this);this.releaseVirtualDocument();this.pendingStyles=null;}},{key:'allocateVirtualDocumentForContent',value:function allocateVirtualDocumentForContent(htmlString){if(!this.virtualDocument){this.virtualDocument=globals.document.createElement('html');}
this.copyNodeAttributesFromContent_(htmlString,this.virtualDocument);this.virtualDocument.innerHTML=htmlString;}},{key:'appendStyleIntoDocument_',value:function appendStyleIntoDocument_(newStyle){var isTemporaryStyle=match(newStyle,HtmlScreen.selectors.stylesTemporary);if(isTemporaryStyle){this.pendingStyles.push(newStyle);}
if(newStyle.id){var styleInDoc=globals.document.getElementById(newStyle.id);if(styleInDoc){styleInDoc.parentNode.insertBefore(newStyle,styleInDoc.nextSibling);return;}}
globals.document.head.appendChild(newStyle);}},{key:'assertSameBodyIdInVirtualDocument',value:function assertSameBodyIdInVirtualDocument(){var bodySurface=this.virtualDocument.querySelector('body');if(!globals.document.body.id){globals.document.body.id='senna_surface_'+getUid$1();}
if(bodySurface){bodySurface.id=globals.document.body.id;}}},{key:'copyNodeAttributesFromContent_',value:function copyNodeAttributesFromContent_(content,node){content=content.replace(/[<]\s*html/ig,'<senna');content=content.replace(/\/html\s*\>/ig,'/senna>');var placeholder=void 0;if(UA.isIe){var tempNode=globals.document.createRange().createContextualFragment(content);placeholder=tempNode.querySelector('senna');}else{node.innerHTML=content;placeholder=node.querySelector('senna');}
if(placeholder){utils.clearNodeAttributes(node);utils.copyNodeAttributes(placeholder,node);}}},{key:'disposeInternal',value:function disposeInternal(){this.disposePendingStyles();get(HtmlScreen.prototype.__proto__||Object.getPrototypeOf(HtmlScreen.prototype),'disposeInternal',this).call(this);}},{key:'disposePendingStyles',value:function disposePendingStyles(){if(this.pendingStyles){utils.removeElementsFromDocument(this.pendingStyles);}}},{key:'evaluateScripts',value:function evaluateScripts(surfaces){var _this2=this;var evaluateTrackedScripts=this.evaluateTrackedResources_(globalEval.runScriptsInElement,HtmlScreen.selectors.scripts,HtmlScreen.selectors.scriptsTemporary,HtmlScreen.selectors.scriptsPermanent);return evaluateTrackedScripts.then(function(){return get(HtmlScreen.prototype.__proto__||Object.getPrototypeOf(HtmlScreen.prototype),'evaluateScripts',_this2).call(_this2,surfaces);});}},{key:'evaluateStyles',value:function evaluateStyles(surfaces){var _this3=this;this.pendingStyles=[];var evaluateTrackedStyles=this.evaluateTrackedResources_(globalEvalStyles.runStylesInElement,HtmlScreen.selectors.styles,HtmlScreen.selectors.stylesTemporary,HtmlScreen.selectors.stylesPermanent,this.appendStyleIntoDocument_.bind(this));return evaluateTrackedStyles.then(function(){return get(HtmlScreen.prototype.__proto__||Object.getPrototypeOf(HtmlScreen.prototype),'evaluateStyles',_this3).call(_this3,surfaces);});}},{key:'evaluateFavicon_',value:function evaluateFavicon_(){var _this4=this;var resourcesInVirtual=this.virtualQuerySelectorAll_(HtmlScreen.selectors.favicon);var resourcesInDocument=this.querySelectorAll_(HtmlScreen.selectors.favicon);return new CancellablePromise(function(resolve){utils.removeElementsFromDocument(resourcesInDocument);_this4.runFaviconInElement_(resourcesInVirtual).then(function(){return resolve();});});}},{key:'evaluateTrackedResources_',value:function evaluateTrackedResources_(evaluatorFn,selector,selectorTemporary,selectorPermanent,opt_appendResourceFn){var _this5=this;var tracked=this.virtualQuerySelectorAll_(selector);var temporariesInDoc=this.querySelectorAll_(selectorTemporary);var permanentsInDoc=this.querySelectorAll_(selectorPermanent);permanentsInDoc.forEach(function(resource){var resourceKey=_this5.getResourceKey_(resource);if(resourceKey){HtmlScreen.permanentResourcesInDoc[resourceKey]=true;}});var frag=buildFragment();tracked.forEach(function(resource){var resourceKey=_this5.getResourceKey_(resource);if(!HtmlScreen.permanentResourcesInDoc[resourceKey]){frag.appendChild(resource);}
if(resourceKey&&match(resource,selectorPermanent)){HtmlScreen.permanentResourcesInDoc[resourceKey]=true;}});return new CancellablePromise(function(resolve){evaluatorFn(frag,function(){utils.removeElementsFromDocument(temporariesInDoc);resolve();},opt_appendResourceFn);});}},{key:'flip',value:function flip(surfaces){var _this6=this;return get(HtmlScreen.prototype.__proto__||Object.getPrototypeOf(HtmlScreen.prototype),'flip',this).call(this,surfaces).then(function(){utils.clearNodeAttributes(globals.document.documentElement);utils.copyNodeAttributes(_this6.virtualDocument,globals.document.documentElement);_this6.evaluateFavicon_();_this6.updateMetaTags_();});}},{key:'updateMetaTags_',value:function updateMetaTags_(){var currentMetaNodes=this.querySelectorAll_('meta');var metasFromVirtualDocument=this.metas;if(currentMetaNodes){utils.removeElementsFromDocument(currentMetaNodes);if(metasFromVirtualDocument){metasFromVirtualDocument.forEach(function(meta){return globals.document.head.appendChild(meta);});}}}},{key:'getResourceKey_',value:function getResourceKey_(resource){return resource.id||resource.href||resource.src||'';}},{key:'getSurfaceContent',value:function getSurfaceContent(surfaceId){var surface=this.virtualDocument.querySelector('#'+surfaceId);if(surface){var defaultChild=surface.querySelector('#'+surfaceId+'-'+Surface.DEFAULT);if(defaultChild){return defaultChild.innerHTML;}
return surface.innerHTML;}}},{key:'getTitleSelector',value:function getTitleSelector(){return this.titleSelector;}},{key:'load',value:function load(path){var _this7=this;return get(HtmlScreen.prototype.__proto__||Object.getPrototypeOf(HtmlScreen.prototype),'load',this).call(this,path).then(function(content){_this7.allocateVirtualDocumentForContent(content);_this7.resolveTitleFromVirtualDocument();_this7.resolveMetaTagsFromVirtualDocument();_this7.assertSameBodyIdInVirtualDocument();if(UA.isIe){_this7.makeTemporaryStylesHrefsUnique_();}
return content;});}},{key:'makeTemporaryStylesHrefsUnique_',value:function makeTemporaryStylesHrefsUnique_(){var _this8=this;var temporariesInDoc=this.virtualQuerySelectorAll_(HtmlScreen.selectors.stylesTemporary);temporariesInDoc.forEach(function(style){return _this8.replaceStyleAndMakeUnique_(style);});}},{key:'replaceStyleAndMakeUnique_',value:function replaceStyleAndMakeUnique_(style){if(style.href){var newStyle=globals.document.createElement(style.tagName);style.href=new Uri(style.href).makeUnique().toString();utils.copyNodeAttributes(style,newStyle);style.parentNode.replaceChild(newStyle,style);style.disabled=true;}}},{key:'runFaviconInElement_',value:function runFaviconInElement_(elements){return new CancellablePromise(function(resolve){elements.forEach(function(element){return document.head.appendChild(UA.isIe?element:utils.setElementWithRandomHref(element));});resolve();});}},{key:'virtualQuerySelectorAll_',value:function virtualQuerySelectorAll_(selector){return Array.prototype.slice.call(this.virtualDocument.querySelectorAll(selector));}},{key:'querySelectorAll_',value:function querySelectorAll_(selector){return Array.prototype.slice.call(globals.document.querySelectorAll(selector));}},{key:'releaseVirtualDocument',value:function releaseVirtualDocument(){this.virtualDocument=null;}},{key:'resolveTitleFromVirtualDocument',value:function resolveTitleFromVirtualDocument(){var title=this.virtualDocument.querySelector(this.titleSelector);if(title){this.setTitle(title.textContent.trim());}}},{key:'resolveMetaTagsFromVirtualDocument',value:function resolveMetaTagsFromVirtualDocument(){var metas=this.virtualQuerySelectorAll_(this.metaTagsSelector);if(metas){this.setMetas(metas);}}},{key:'setTitleSelector',value:function setTitleSelector(titleSelector){this.titleSelector=titleSelector;}}]);return HtmlScreen;}(RequestScreen);var ignoreFavicon=':not([rel="Shortcut Icon"]):not([rel="shortcut icon"]):not([rel="icon"]):not([href$="favicon.icon"])';HtmlScreen.selectors={favicon:'link[rel="Shortcut Icon"],link[rel="shortcut icon"],link[rel="icon"],link[href$="favicon.icon"]',scripts:'script[data-senna-track]',scriptsPermanent:'script[data-senna-track="permanent"]',scriptsTemporary:'script[data-senna-track="temporary"]',styles:'style[data-senna-track],link[data-senna-track]'+ignoreFavicon,stylesPermanent:'style[data-senna-track="permanent"],link[data-senna-track="permanent"]'+ignoreFavicon,stylesTemporary:'style[data-senna-track="temporary"],link[data-senna-track="temporary"]'+ignoreFavicon};HtmlScreen.permanentResourcesInDoc={};var AppDataAttributeHandler=function(_Disposable){inherits(AppDataAttributeHandler,_Disposable);function AppDataAttributeHandler(){classCallCheck(this,AppDataAttributeHandler);var _this=possibleConstructorReturn(this,(AppDataAttributeHandler.__proto__||Object.getPrototypeOf(AppDataAttributeHandler)).call(this));_this.app=null;_this.baseElement=null;return _this;}
createClass(AppDataAttributeHandler,[{key:'handle',value:function handle(){if(!isElement$1(this.baseElement)){throw new Error('Senna data attribute handler base element '+'not set or invalid, try setting a valid element that '+'contains a `data-senna` attribute.');}
if(!this.baseElement.hasAttribute(dataAttributes.senna)){console.log('Senna was not initialized from data attributes. '+'In order to enable its usage from data attributes try setting '+'in the base element, e.g. `<body data-senna>`.');return;}
if(this.app){throw new Error('Senna app was already initialized.');}
console.log('Senna initialized from data attribute.');this.app=new App$1();this.maybeAddRoutes_();this.maybeAddSurfaces_();this.maybeSetBasePath_();this.maybeSetLinkSelector_();this.maybeSetLoadingCssClass_();this.maybeSetUpdateScrollPosition_();this.maybeDispatch_();}},{key:'disposeInternal',value:function disposeInternal(){if(this.app){this.app.dispose();}}},{key:'getApp',value:function getApp(){return this.app;}},{key:'getBaseElement',value:function getBaseElement(){return this.baseElement;}},{key:'maybeAddRoutes_',value:function maybeAddRoutes_(){var _this2=this;var routesSelector='link[rel="senna-route"]';this.querySelectorAllAsArray_(routesSelector).forEach(function(link){return _this2.maybeParseLinkRoute_(link);});if(!this.app.hasRoutes()){this.app.addRoutes(new Route(/.*/,HtmlScreen));console.log('Senna can\'t find route elements, adding default.');}}},{key:'maybeAddSurfaces_',value:function maybeAddSurfaces_(){var _this3=this;var surfacesSelector='['+dataAttributes.surface+']';this.querySelectorAllAsArray_(surfacesSelector).forEach(function(surfaceElement){_this3.updateElementIdIfSpecialSurface_(surfaceElement);_this3.app.addSurfaces(surfaceElement.id);});}},{key:'maybeDispatch_',value:function maybeDispatch_(){if(this.baseElement.hasAttribute(dataAttributes.dispatch)){this.app.dispatch();}}},{key:'maybeParseLinkRoute_',value:function maybeParseLinkRoute_(link){var route=new Route(this.maybeParseLinkRoutePath_(link),this.maybeParseLinkRouteHandler_(link));this.app.addRoutes(route);console.log('Senna scanned route '+route.getPath());}},{key:'maybeParseLinkRouteHandler_',value:function maybeParseLinkRouteHandler_(link){var handler=link.getAttribute('type');if(isDefAndNotNull$1(handler)){handler=object$2.getObjectByName(handler);}
return handler;}},{key:'maybeParseLinkRoutePath_',value:function maybeParseLinkRoutePath_(link){var path=link.getAttribute('href');if(isDefAndNotNull$1(path)){if(path.indexOf('regex:')===0){path=new RegExp(path.substring(6));}}
return path;}},{key:'maybeSetBasePath_',value:function maybeSetBasePath_(){var basePath=this.baseElement.getAttribute(dataAttributes.basePath);if(isDefAndNotNull$1(basePath)){this.app.setBasePath(basePath);console.log('Senna scanned base path '+basePath);}}},{key:'maybeSetLinkSelector_',value:function maybeSetLinkSelector_(){var linkSelector=this.baseElement.getAttribute(dataAttributes.linkSelector);if(isDefAndNotNull$1(linkSelector)){this.app.setLinkSelector(linkSelector);console.log('Senna scanned link selector '+linkSelector);}}},{key:'maybeSetLoadingCssClass_',value:function maybeSetLoadingCssClass_(){var loadingCssClass=this.baseElement.getAttribute(dataAttributes.loadingCssClass);if(isDefAndNotNull$1(loadingCssClass)){this.app.setLoadingCssClass(loadingCssClass);console.log('Senna scanned loading css class '+loadingCssClass);}}},{key:'maybeSetUpdateScrollPosition_',value:function maybeSetUpdateScrollPosition_(){var updateScrollPosition=this.baseElement.getAttribute(dataAttributes.updateScrollPosition);if(isDefAndNotNull$1(updateScrollPosition)){if(updateScrollPosition==='false'){this.app.setUpdateScrollPosition(false);}else{this.app.setUpdateScrollPosition(true);}
console.log('Senna scanned update scroll position '+updateScrollPosition);}}},{key:'querySelectorAllAsArray_',value:function querySelectorAllAsArray_(selector){return Array.prototype.slice.call(globals.document.querySelectorAll(selector));}},{key:'updateElementIdIfSpecialSurface_',value:function updateElementIdIfSpecialSurface_(element){if(!element.id&&element===globals.document.body){element.id='senna_surface_'+getUid$1();}}},{key:'setBaseElement',value:function setBaseElement(baseElement){this.baseElement=baseElement;}}]);return AppDataAttributeHandler;}(Disposable$2);var dataAttributeHandler=new AppDataAttributeHandler();globals.document.addEventListener('DOMContentLoaded',function(){dataAttributeHandler.setBaseElement(globals.document.body);dataAttributeHandler.handle();});var version='2.7.7';exports['default']=App$1;exports.dataAttributeHandler=dataAttributeHandler;exports.utils=utils;exports.App=App$1;exports.HtmlScreen=HtmlScreen;exports.Route=Route;exports.RequestScreen=RequestScreen;exports.Screen=Screen;exports.version=version;Object.defineProperty(exports,'__esModule',{value:true});})));
